<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicMedia - Media Player & Feed</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #e74c3c;
            --accent-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-radius: 0px;
            --panel-border: 3px solid #000;
            --panel-shadow: 5px 5px 0px #000;
            --font-main: 'Bangers', 'Comic Sans MS', cursive;
            --font-content: 'Roboto', sans-serif;
            
            /* Dark mode specific variables */
            --dark-bg-color: #1a0e2a;
            --dark-panel-bg: #ffd700;
            --dark-text-color: #e0e0e0;
            --dark-border-color: #572a84;
            --dark-input-bg: #361c54;
            --dark-item-hover: #4e2a77;
            --dark-item-active: #5e3590;
            --text-outline: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-content);
            background-color: #1a0e2a;
            background-image: 
                radial-gradient(circle, #4b1e81 10%, transparent 10%),
                radial-gradient(circle, #2d1145 10%, transparent 10%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            overflow-x: hidden;
            max-width: 100vw;
            line-height: 1.2;
            -webkit-tap-highlight-color: transparent;
            color: #e0e0e0;
            text-shadow: var(--text-outline);
        }

        /* Comic Book Styling */
        .comic-panel {
            background-color: white;
            border: var(--panel-border);
            box-shadow: var(--panel-shadow);
            margin: 8px 4px;
            position: relative;
            overflow: hidden;
        }

        .comic-panel::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            border-width: 0 15px 15px 0;
            border-style: solid;
            border-color: #f0f0f0 #4e2a77;
            box-shadow: -2px 2px 0px #000;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .comic-panel::before:hover {
            border-width: 0 17px 17px 0;
        }

        .comic-header {
            font-family: var(--font-main);
            text-align: center;
            text-transform: uppercase;
            color: pink;
            text-shadow: var(--text-outline), 2px 2px 0px #fff;
            padding: 8px;
            letter-spacing: 1px;
        }

        .pow-btn {
            background-color: pink;
            border: 2px solid black;
            border-radius: 0;
            font-family: var(--font-main);
            font-weight: bold;
            color: white;
            text-shadow: var(--text-outline);
            box-shadow: 2px 2px 0px #000;
            transition: transform 0.1s ease;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .pow-btn:active {
            transform: scale(0.95);
            box-shadow: 1px 1px 0px #000;
        }

        /* App Container */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 5px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 2px;
            background-color: #4e2a77;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid black;
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin: 0 2px;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
            user-select: none;
            -webkit-user-select: none;
        }

        .tab.active {
            background-color: white;
            color: var(--dark-color);
            border-bottom: 2px solid white;
            bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Media Player */
        .media-player {
            width: 100%;
            background-color: white;
            border-radius: var(--border-radius);
            margin-left: 0px;
        }

        .video-container {
            position: relative;
            width: 100%;
            background-color: #000;
            overflow: hidden;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }

        .video-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }

        .video-element, 
        .audio-element {
            max-width: 100%;
            max-height: 100%;
            margin: auto;
            object-fit: contain;
        }

        iframe.video-element {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .visualizer-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        .visualizer-canvas {
            width: 100%;
            height: 100%;
        }

        .audio-info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 1);
            z-index: 10;
            text-align: center;
            text-shadow: var(--text-outline);
        }

        .audio-info-overlay.hidden {
            display: none;
        }

        .player-controls {
            display: flex;
            align-items: center;
            padding: 5px;
            background-color: cyan;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .control-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin: 0 2px;
            padding: 5px;
            font-size: 1rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .control-button:focus {
            outline: none;
        }

        .control-button.active {
            color: var(--accent-color);
        }

        .timeline-container {
            flex: 1;
            margin: 0 5px;
            position: relative;
            height: 15px;
            display: flex;
            align-items: center;
        }

        .timeline {
            width: 100%;
            height: 6px;
            background-color: #4e2a77;
            border-radius: 0;
            cursor: pointer;
            position: relative;
        }

        .timeline-progress {
            height: 100%;
            background-color: #00ffff;
            border-radius: 0;
            width: 0%;
            position: relative;
        }
        
        .timeline-progress::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -2px;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 0;
            border: 1px solid #00ffff;
            display: none;
        }
        
        .timeline:hover .timeline-progress::after {
            display: block;
        }

        .timeline-buffer {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: rgba(142, 68, 220, 0.3);
            border-radius: 0;
        }

        .time-display {
            font-size: 0.7rem;
            white-space: nowrap;
            color: white;
            margin: 0 2px;
        }

        .volume-container {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: 5px;
        }

        .volume-slider {
            width: 60px;
            height: 5px;
            margin-left: 5px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background: #4e2a77;
            border-radius: 0;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 0;
            border: 1px solid #00ffff;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 0;
            border: 1px solid #00ffff;
        }

        .playlist-toggle {
            margin-left: 5px;
        }

        .settings-toggle {
            margin-left: 5px;
        }

        .playlist-container {
            background-color: white;
            border: var(--panel-border);
            border-top: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .playlist-container.open {
            max-height: 300px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #4e2a77;
            cursor: pointer;
        }

        .playlist-item:hover {
            background-color: #5e3590;
        }

        .playlist-item.active {
            background-color: #4e2a77;
            border-left: 3px solid var(--primary-color);
        }

        .playlist-item-drag {
            margin-right: 8px;
            cursor: grab;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        .playlist-item-info {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .playlist-item-type {
            margin-left: 8px;
            padding: 2px 4px;
            border-radius: 0;
            font-size: 0.75rem;
            background-color: var(--dark-color);
            color: white;
            text-shadow: var(--text-outline);
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            overflow-y: auto;
        }

        .modal.open {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 15px;
            width: 90%;
            max-width: 600px;
            border-radius: 0;
            border: var(--panel-border);
            box-shadow: var(--panel-shadow);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #4e2a77;
            padding-bottom: 10px;
        }

        .modal-title {
            font-family: var(--font-main);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #4e2a77;
            margin-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .modal-tabs::-webkit-scrollbar {
            display: none;
        }

        .modal-tab {
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
            user-select: none;
            -webkit-user-select: none;
        }

        .modal-tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .url-list {
            margin-bottom: 15px;
        }

        .url-category {
            margin-bottom: 10px;
        }

        .url-category-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .url-item {
            background-color: #f0f0f0;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 0;
            font-size: 0.9rem;
            word-break: break-all;
            position: relative;
        }

        .url-actions {
            display: flex;
            margin-top: 5px;
        }

        .url-action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 0;
            margin-right: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            text-shadow: var(--text-outline);
        }

        .visualizer-options {
            margin-bottom: 15px;
        }

        .visualizer-type {
            margin-bottom: 10px;
        }

        .visualizer-type label {
            margin-left: 5px;
        }

        .add-url-form {
            margin-top: 15px;
        }

        .add-url-form input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #4e2a77;
            border-radius: 0;
            text-shadow: var(--text-outline);
        }

        .add-url-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #4e2a77;
            border-radius: 0;
            text-shadow: var(--text-outline);
        }

        .add-url-form button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 0;
            cursor: pointer;
        }

        /* Post Feed */
        .post-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-feed-actions {
            display: flex;
        }

        .new-post-btn, .filter-toggle, .clear-filters-btn {
            border-radius: 0;
        }

        .filter-panel {
            background-color: white;
            padding: 10px;
            border-radius: 0;
            margin-bottom: 10px;
            display: none;
            position: relative;
        }

        .filter-panel.open {
            display: block;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-option {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .filter-search {
            margin-bottom: 10px;
            width: 100%;
        }

        .filter-search input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--dark-color);
            border-radius: 0;
            background-color: white;
            color: var(--dark-color);
            font-family: var(--font-content);
            text-shadow: var(--text-outline);
        }

        .tag-dropdown {
            margin-bottom: 10px;
            position: relative;
        }

        .tag-dropdown-select {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--dark-color);
            border-radius: 0;
            background-color: white;
            color: var(--dark-color);
            font-family: var(--font-content);
            cursor: pointer;
            text-shadow: var(--text-outline);
        }

        .sort-options {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .sort-option {
            margin-right: 10px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .sort-option input[type="radio"] {
            margin-right: 5px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--dark-color);
            border-radius: 0;
            background-color: white;
            display: inline-block;
            position: relative;
            cursor: pointer;
        }
        
        .sort-option input[type="radio"]:checked {
            border-color: var(--primary-color);
        }
        
        .sort-option input[type="radio"]:checked::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            border-radius: 0;
            background: var(--primary-color);
        }

        .filter-option {
            margin-right: 10px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .filter-option input[type="checkbox"] {
            margin-right: 5px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--dark-color);
            border-radius: 0;
            background-color: white;
            display: inline-block;
            position: relative;
            cursor: pointer;
        }
        
        .filter-option input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .filter-option input[type="checkbox"]:checked::after {
            content: "";
            position: absolute;
            left: 5px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .filter-option label {
            cursor: pointer;
        }

        .post-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        @media (min-width: 600px) {
            .post-grid {
                grid-template-columns: 1fr;
                max-width: 100%;
                margin: 0 auto;
            }
        }

        .post {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .post-header {
            padding: 8px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .post-title {
            font-weight: bold;
            margin: 0;
            font-size: 1rem;
            margin-left: 5px;
            flex-grow: 1;
        }

        .post-actions {
            display: flex;
            margin-right: 10px;
        }

        .post-action {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 5px;
            color: #9d65dd;
        }

        .post-content {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .post-content.video-content {
            padding-top: 56.25%; /* 16:9 Aspect Ratio for videos only */
        }

        .post-embed {
            position: relative;
            width: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .post-embed.video-embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .post-embed:not(iframe.video-embed):not(video.video-embed) {
            object-position: center top;
            margin-top: 0;
        }

        .post-footer {
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            max-width: 70%;
        }

        .post-tag {
            background-color: #4e2a77;
            padding: 2px 5px;
            border-radius: 0;
            margin-right: 5px;
            margin-bottom: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            text-shadow: var(--text-outline);
            color: white;
        }
        
        .post-tag:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .post-date {
            color: #9d65dd;
            font-size: 0.8rem;
        }

        .post.collapsed .post-content,
        .post.collapsed .post-footer {
            display: none;
        }
        
        .post.collapsed {
            margin-bottom: 5px;
        }
        
        .corner-fold-tooltip {
            position: absolute;
            top: 0;
            right: 16px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 10;
        }
        
        .comic-panel:hover .corner-fold-tooltip {
            opacity: 1;
        }

        .corner-fold-click-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            z-index: 11;
            cursor: pointer;
        }

        /* New Post Modal */
        .post-form-group {
            margin-bottom: 10px;
        }

        .post-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .post-form-group input,
        .post-form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #4e2a77;
            border-radius: 0;
            text-shadow: var(--text-outline);
        }

        .post-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            border: 1px solid #4e2a77;
            border-radius: 0;
            padding: 5px;
            min-height: 38px;
            align-items: center;
        }

        .tag-item {
            background-color: #4e2a77;
            padding: 2px 5px;
            border-radius: 0;
            margin-right: 5px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            text-shadow: var(--text-outline);
            color: white;
        }

        .tag-remove {
            margin-left: 5px;
            cursor: pointer;
        }

        .tags-input input {
            border: none;
            outline: none;
            flex: 1;
            padding: 3px;
            min-width: 60px;
            height: 24px;
        }

        /* Responsive */
        @media (hover: none) {
            .timeline-progress::after {
                display: block;
                width: 14px;
                height: 14px;
                top: -4px;
            }
            
            .control-button,
            .pow-btn,
            .tab {
                padding: 8px; /* Larger touch targets */
            }
            
            .player-controls {
                padding: 8px 5px;
            }
        }
        
        /* Icons */
        .icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
            vertical-align: middle;
        }

        /* Animation */
        @keyframes pow {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pow-animation {
            animation: pow 0.3s ease;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(142, 68, 220, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 80%;
            max-width: 300px;
        }
        
        .toast {
            background-color: rgba(0, 0, 0, 1);
            color: white;
            padding: 10px 15px;
            border-radius: 0;
            font-size: 0.9rem;
            box-shadow: 5px 5px 0px #000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            text-align: center;
            text-shadow: var(--text-outline);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Control tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: auto;
            min-width: 60px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            border-radius: 0;
            padding: 3px 8px;
            font-size: 0.7rem;
            
            /* Position the tooltip */
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            
            /* Fade in/out */
            opacity: 0;
            transition: opacity 0.3s;
            
            /* Prevent tooltip from affecting layout */
            pointer-events: none;
            white-space: nowrap;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        
        /* Dark mode styles */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--dark-bg-color);
                background-image: 
                    radial-gradient(circle, #4b1e81 10%, transparent 10%),
                    radial-gradient(circle, #2d1145 10%, transparent 10%);
                color: var(--dark-text-color);
            }
            
            .filter-panel, 
            .comic-panel,
            .modal-content,
            .playlist-container,
            .post {
                background-color: var(--dark-panel-bg);
                color: var(--dark-text-color);
            }
            
            .tab.active {
                background-color: var(--dark-panel-bg);
                color: var(--dark-text-color);
                border-bottom: 2px solid var(--dark-panel-bg);
            }
            
            .post-header,
            .post-footer,
            .modal-header,
            .playlist-item {
                border-color: var(--dark-border-color);
            }
            
            .url-item,
            .tag-item,
            .post-tag,
            .tag-dropdown-select,
            .filter-search input {
                background-color: var(--dark-input-bg);
                color: var(--dark-text-color);
                border-color: var(--dark-border-color);
            }
            
            .playlist-item.active {
                background-color: var(--dark-item-active);
            }
            
            .playlist-item:hover {
                background-color: var(--dark-item-hover);
            }
            
            .add-url-form input,
            .add-url-form select,
            .post-form-group input,
            .post-form-group textarea,
            .tags-input {
                background-color: var(--dark-input-bg);
                border-color: var(--dark-border-color);
                color: var(--dark-text-color);
            }
            
            .tags-input input {
                color: var(--dark-text-color);
            }
            
            /* Dark mode filter control updates */
            .filter-search input,
            .tag-dropdown-select {
                background-color: var(--dark-input-bg);
                color: var(--dark-text-color);
                border-color: var(--dark-border-color);
            }
            
            .filter-option input[type="checkbox"],
            .sort-option input[type="radio"] {
                background-color: var(--dark-input-bg);
                border-color: var(--dark-border-color);
            }
            
            .sort-option label,
            .filter-option label {
                color: var(--dark-text-color);
            }
            
            .modal-tab {
                color: var(--dark-text-color);
            }
            
            .modal-tab.active {
                color: var(--primary-color);
            }
        }
        
        /* Filter Control Updates */
        .filter-panel.comic-panel::before {
            display: none;
        }
        
        .filter-panel .corner-fold-tooltip,
        .filter-panel .corner-fold-click-area {
            display: none;
        }

        /* Dark mode filter control updates */
        @media (prefers-color-scheme: dark) {
            .filter-search input,
            .tag-dropdown-select {
                background-color: var(--dark-input-bg);
                color: var(--dark-text-color);
                border-color: var(--dark-border-color);
            }
            
            .filter-option input[type="checkbox"],
            .sort-option input[type="radio"] {
                background-color: var(--dark-input-bg);
                border-color: var(--dark-border-color);
            }
            
            .filter-option input[type="checkbox"]:checked {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }
            
            .sort-option input[type="radio"]:checked {
                border-color: var(--primary-color);
            }
        }
        
        /* Fix post-content that's not video to be at the top */
        .post-content:not(.video-content) {
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 0;
        }
        
        .post-embed:not(iframe.video-embed):not(video.video-embed) {
            object-position: center top;
            margin-top: 0;
        }
        
        /* Make the corner fold clickable area cover the entire corner */
        .corner-fold-click-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            z-index: 11;
            cursor: pointer;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <h1 class="comic-header">Comic Media</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="media-player">Media Player</div>
            <div class="tab" data-tab="post-feed">Post Feed</div>
        </div>
        
        <div class="tab-content active" id="media-player">
            <div class="comic-panel media-player">
                <div class="video-container">
                    <div class="video-screen">
                        <!-- Media content will be loaded here -->
                        <div class="audio-info-overlay hidden">
                            <h3 class="audio-title">No Audio Playing</h3>
                            <p class="audio-url">No URL</p>
                        </div>
                        <div class="visualizer-container">
                            <canvas class="visualizer-canvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="player-controls">
                    <button class="control-button play-pause-btn tooltip">
                        <span class="tooltip-text">Play/Pause</span>
                        <svg class="icon play-icon" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg class="icon pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>
                    <button class="control-button prev-btn tooltip">
                        <span class="tooltip-text">Previous</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                        </svg>
                    </button>
                    <button class="control-button next-btn tooltip">
                        <span class="tooltip-text">Next</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6h2v12h-2V6z"/>
                        </svg>
                    </button>
                    <span class="time-display">0:00 / 0:00</span>
                    <div class="timeline-container tooltip">
                        <span class="tooltip-text">Seek</span>
                        <div class="timeline">
                            <div class="timeline-buffer"></div>
                            <div class="timeline-progress"></div>
                        </div>
                    </div>
                    <div class="volume-container">
                        <button class="control-button volume-btn tooltip">
                            <span class="tooltip-text">Mute/Unmute</span>
                            <svg class="icon volume-high-icon" viewBox="0 0 24 24">
                                <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm0.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                            </svg>
                            <svg class="icon volume-mute-icon" viewBox="0 0 24 24" style="display: none;">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
                            </svg>
                        </button>
                        <div class="tooltip">
                            <span class="tooltip-text">Volume</span>
                            <input type="range" class="volume-slider" min="0" max="100" value="100">
                        </div>
                    </div>
                    <button class="control-button playlist-toggle tooltip">
                        <span class="tooltip-text">Playlist</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5-3z"/>
                        </svg>
                    </button>
                    <button class="control-button repeat-playlist-btn tooltip">
                        <span class="tooltip-text">Repeat Playlist</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M17 17H7v-3l-4 4 4 4v-3h12v-6h-2M7 7h10v3l4-4-4-4v3H5v6h2V7z"/>
                        </svg>
                    </button>
                    <button class="control-button repeat-one-btn tooltip">
                        <span class="tooltip-text">Repeat One</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M13 15V9h-1l-2 1v1h1.5v4m5.5 2H7v-3l-4 4 4 4v-3h12v-6h-2M7 7h10v3l4-4-4-4v3H5v6h2V7z"/>
                        </svg>
                    </button>
                    <button class="control-button shuffle-btn tooltip">
                        <span class="tooltip-text">Shuffle</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm0.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                        </svg>
                    </button>
                    <button class="control-button settings-toggle tooltip">
                        <span class="tooltip-text">Settings</span>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="playlist-container">
                <!-- Playlist items will be dynamically added here -->
            </div>
        </div>
        
        <div class="tab-content" id="post-feed">
            <div class="post-feed-header">
                <h2 class="comic-header" style="padding: 0; margin: 0; font-size: 1.5rem;">Recent Posts</h2>
                <div class="post-feed-actions">
                    <button class="pow-btn new-post-btn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        New
                    </button>
                    <button class="pow-btn filter-toggle">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M10 8v8l6-4-6-4v8H6V4h14V4H6v4h4v4h6v-4h2v4h4v-4h2v-4h-4V8h4z"/>
                        </svg>
                        Filter
                    </button>
                </div>
            </div>
            
            <div class="filter-panel comic-panel">
                <button class="clear-filters-btn pow-btn">Clear Filters</button>
                <div class="filter-options">
                    <div class="filter-option">
                        <input type="checkbox" id="filter-video" class="filter-checkbox" data-type="video">
                        <label for="filter-video">Videos</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-audio" class="filter-checkbox" data-type="audio">
                        <label for="filter-audio">Audio</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-image" class="filter-checkbox" data-type="image">
                        <label for="filter-image">Images</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-other" class="filter-checkbox" data-type="other">
                        <label for="filter-other">Other</label>
                    </div>
                </div>
                <div class="filter-search">
                    <input type="text" id="search-input" placeholder="Search posts...">
                </div>
                <div class="tag-dropdown">
                    <select id="tag-filter" class="tag-dropdown-select">
                        <option value="">-- Filter by tag --</option>
                        <!-- Tags will be populated dynamically -->
                    </select>
                </div>
                <div class="sort-options">
                    <div class="sort-option">
                        <input type="radio" name="sort" id="sort-newest" value="newest" checked>
                        <label for="sort-newest">Newest</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" name="sort" id="sort-oldest" value="oldest">
                        <label for="sort-oldest">Oldest</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" name="sort" id="sort-a-z" value="a-z">
                        <label for="sort-a-z">A-Z</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" name="sort" id="sort-z-a" value="z-a">
                        <label for="sort-z-a">Z-A</label>
                    </div>
                </div>
            </div>
            
            <div class="post-grid">
                <!-- Posts will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Media Settings</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="url-list">Media URLs</div>
                <div class="modal-tab" data-tab="visualizer-settings">Visualizer</div>
                <div class="modal-tab" data-tab="add-url">Add New URL</div>
            </div>
            <div class="modal-tab-content active" id="url-list">
                <div class="url-list">
                    <div class="url-category">
                        <div class="url-category-title">
                            <svg class="icon" viewBox="0 0 24 24" style="margin-right: 5px;">
                                <path d="M10 8v8l6-4-6-4zM18 2H6C4.9 2 4 2.9 4 4v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H6V4h12v14z"/>
                            </svg>
                            YouTube Videos
                        </div>
                        <div class="url-items youtube-urls">
                            <!-- YouTube URLs will be added here -->
                        </div>
                    </div>
                    <div class="url-category">
                        <div class="url-category-title">
                            <svg class="icon" viewBox="0 0 24 24" style="margin-right: 5px;">
                                <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 5h-3v5.5c0 1.38-1.12 2.5-2.5 2.5S10 13.88 10 12.5s1.12-2.5 2.5-2.5c.57 0 1.08.19 1.5.51V5h4v2zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
                            </svg>
                            Audio Files
                        </div>
                        <div class="url-items audio-urls">
                            <!-- Audio URLs will be added here -->
                        </div>
                    </div>
                    <div class="url-category">
                        <div class="url-category-title">
                            <svg class="icon" viewBox="0 0 24 24" style="margin-right: 5px;">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
                            </svg>
                            Video Files
                        </div>
                        <div class="url-items video-urls">
                            <!-- Video URLs will be added here -->
                        </div>
                    </div>
                    <div class="url-category">
                        <div class="url-category-title">
                            <svg class="icon" viewBox="0 0 24 24" style="margin-right: 5px;">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm0 0H6V5h15v14z"/>
                            </svg>
                            Images & GIFs
                        </div>
                        <div class="url-items image-urls">
                            <!-- Image URLs will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-tab-content" id="visualizer-settings">
                <div class="visualizer-options">
                    <h4>Visualizer Type</h4>
                    <div class="visualizer-type">
                        <input type="radio" name="visualizer-type" id="bars" value="bars" checked>
                        <label for="bars">Bars</label>
                    </div>
                    <div class="visualizer-type">
                        <input type="radio" name="visualizer-type" id="wave" value="wave">
                        <label for="wave">Wave</label>
                    </div>
                    <div class="visualizer-type">
                        <input type="radio" name="visualizer-type" id="circle" value="circle">
                        <label for="circle">Circle</label>
                    </div>
                    <div class="visualizer-type">
                        <input type="radio" name="visualizer-type" id="particles" value="particles">
                        <label for="particles">Particles</label>
                    </div>
                    <div class="visualizer-type">
                        <input type="radio" name="visualizer-type" id="none" value="none">
                        <label for="none">None</label>
                    </div>
                    
                    <h4>Visualizer Color</h4>
                    <input type="color" id="visualizer-color" value="#3498db">
                    
                    <h4>Show Audio Info</h4>
                    <div class="visualizer-type">
                        <input type="checkbox" id="show-audio-info" checked>
                        <label for="show-audio-info">Display audio information</label>
                    </div>
                </div>
            </div>
            <div class="modal-tab-content" id="add-url">
                <div class="add-url-form">
                    <input type="text" id="new-url" placeholder="Enter media URL">
                    <select id="url-type">
                        <option value="">-- Select media type --</option>
                        <option value="youtube">YouTube Video</option>
                        <option value="youtube-playlist">YouTube Playlist</option>
                        <option value="mp3">MP3 Audio</option>
                        <option value="wav">WAV Audio</option>
                        <option value="flac">FLAC Audio</option>
                        <option value="mp4">MP4 Video</option>
                        <option value="gif">GIF Image</option>
                    </select>
                    <input type="text" id="url-title" placeholder="Title (optional)">
                    <button id="add-url-btn" class="pow-btn">Add to Playlist</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Post Modal -->
    <div class="modal" id="new-post-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Post</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="post-form">
                <div class="post-form-group">
                    <label for="post-title">Title</label>
                    <input type="text" id="post-title" placeholder="Enter post title">
                </div>
                <div class="post-form-group">
                    <label for="post-embed">Embed Code or URL</label>
                    <textarea id="post-embed" placeholder="Paste embed code or URL here"></textarea>
                </div>
                <div class="post-form-group">
                    <label for="post-tags">Tags</label>
                    <div class="tags-input">
                        <input type="text" id="tag-input" placeholder="Add tags...">
                    </div>
                </div>
                <button id="create-post" class="pow-btn" style="width: 100%;">Create Post</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Post Modal -->
    <div class="modal" id="edit-post-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Post</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="post-form">
                <input type="hidden" id="edit-post-id">
                <div class="post-form-group">
                    <label for="edit-post-title">Title</label>
                    <input type="text" id="edit-post-title" placeholder="Enter post title">
                </div>
                <div class="post-form-group">
                    <label for="edit-post-embed">Embed Code or URL</label>
                    <textarea id="edit-post-embed" placeholder="Paste embed code or URL here"></textarea>
                </div>
                <div class="post-form-group">
                    <label for="edit-post-tags">Tags</label>
                    <div class="tags-input" id="edit-tags-container">
                        <input type="text" id="edit-tag-input" placeholder="Add tags...">
                    </div>
                </div>
                <button id="update-post" class="pow-btn" style="width: 100%;">Update Post</button>
            </div>
        </div>
    </div>
    
    <!-- Toast notifications container -->
    <div class="toast-container"></div>

    <script>
        // Utility functions
        function $(selector) {
            return document.querySelector(selector);
        }
        
        function $$(selector) {
            return document.querySelectorAll(selector);
        }
        
        // Toast notification
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = message;
            
            $('.toast-container').appendChild(toast);
            
            // Force reflow to enable transition
            void toast.offsetWidth;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            initTabs();
            
            // Initialize media player
            initMediaPlayer();
            
            // Initialize post feed
            initPostFeed();
            
            // Initialize modals
            initModals();
            
            // Set up lazy loading for post embeds
            setupLazyLoading();
            
            // Set up corner fold functionality
            setupCornerFolds();
        });
        
        // Tab functionality
        function initTabs() {
            const tabs = $$('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Deactivate all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    $$('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Activate clicked tab
                    this.classList.add('active');
                    $(`#${tabId}`).classList.add('active');
                });
            });
            
            // Modal tabs
            const modalTabs = $$('.modal-tab');
            
            modalTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Deactivate all modal tabs
                    modalTabs.forEach(t => t.classList.remove('active'));
                    $$('.modal-tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Activate clicked modal tab
                    this.classList.add('active');
                    $(`#${tabId}`).classList.add('active');
                });
            });
        }
        
        // Media Player functionality
        function initMediaPlayer() {
            window.mediaPlayer = {
                container: $('.media-player'),
                videoScreen: $('.video-screen'),
                audioInfoOverlay: null,
                visualizerCanvas: null,
                playPauseBtn: $('.play-pause-btn'),
                playIcon: $('.play-icon'),
                pauseIcon: $('.pause-icon'),
                prevBtn: $('.prev-btn'),
                nextBtn: $('.next-btn'),
                timeDisplay: $('.time-display'),
                timeline: $('.timeline'),
                timelineProgress: $('.timeline-progress'),
                timelineBuffer: $('.timeline-buffer'),
                volumeBtn: $('.volume-btn'),
                volumeHighIcon: $('.volume-high-icon'),
                volumeMuteIcon: $('.volume-mute-icon'),
                volumeSlider: $('.volume-slider'),
                playlistToggle: $('.playlist-toggle'),
                repeatPlaylistBtn: $('.repeat-playlist-btn'),
                repeatOneBtn: $('.repeat-one-btn'),
                shuffleBtn: $('.shuffle-btn'),
                settingsToggle: $('.settings-toggle'),
                playlistContainer: $('.playlist-container'),
                playlist: [],
                currentIndex: 0,
                audioContext: null,
                analyser: null,
                mediaElement: null,
                visualizerType: 'bars',
                visualizerColor: '#3498db',
                showAudioInfo: true,
                isPlaying: false,
                animationId: null,
                particles: [],
                ytPlayer: null,
                youtubeProgressTimer: null,
                repeatPlaylist: false,
                repeatOne: false,
                shuffle: false,
                
                init: function() {
                    // Make sure we have all required elements
                    this.ensureElements();
                    
                    // Load playlist from localStorage
                    this.loadPlaylist();
                    
                    // Initialize audio context for visualizer
                    this.initAudioContext();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Render playlist
                    this.renderPlaylist();
                    
                    // Setup visualizer
                    this.setupVisualizer();
                    
                    // Add some sample media
                    if (this.playlist.length === 0) {
                        this.addSampleMedia();
                    }
                    
                    // Auto detect URL type
                    this.setupUrlTypeDetection();
                    
                    // Load playback settings
                    this.loadPlaybackSettings();
                },
                
                ensureElements: function() {
                    // Create audio info overlay if it doesn't exist
                    if (!this.audioInfoOverlay) {
                        this.audioInfoOverlay = document.createElement('div');
                        this.audioInfoOverlay.classList.add('audio-info-overlay');
                        if (!this.showAudioInfo) {
                            this.audioInfoOverlay.classList.add('hidden');
                        }
                        this.audioInfoOverlay.innerHTML = `
                            <h3 class="audio-title">No Audio Playing</h3>
                            <p class="audio-url">No URL</p>
                        `;
                        this.videoScreen.appendChild(this.audioInfoOverlay);
                    }
                    
                    // Create visualizer container and canvas if needed
                    if (!document.querySelector('.visualizer-container')) {
                        const visualizerContainer = document.createElement('div');
                        visualizerContainer.classList.add('visualizer-container');
                        const canvas = document.createElement('canvas');
                        canvas.classList.add('visualizer-canvas');
                        visualizerContainer.appendChild(canvas);
                        this.videoScreen.appendChild(visualizerContainer);
                        this.visualizerCanvas = canvas;
                    } else if (!this.visualizerCanvas) {
                        this.visualizerCanvas = $('.visualizer-canvas');
                        
                        if (!this.visualizerCanvas) {
                            console.error('Could not create visualizer canvas');
                            return;
                        }
                    }
                },
                
                initAudioContext: function() {
                    try {
                        window.AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioContext = new AudioContext();
                    } catch (e) {
                        console.warn('Web Audio API is not supported in this browser');
                    }
                },
                
                setupEventListeners: function() {
                    // Play/Pause button
                    this.playPauseBtn.addEventListener('click', () => {
                        this.togglePlay();
                    });
                    
                    // Previous button
                    this.prevBtn.addEventListener('click', () => {
                        this.playPrevious();
                    });
                    
                    // Next button
                    this.nextBtn.addEventListener('click', () => {
                        this.playNext();
                    });
                    
                    // Timeline - mouse/touch events
                    let isDraggingTimeline = false;
                    
                    this.timeline.addEventListener('mousedown', (e) => {
                        isDraggingTimeline = true;
                        this.updateTimelinePosition(e);
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (isDraggingTimeline) {
                            this.updateTimelinePosition(e);
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        isDraggingTimeline = false;
                    });
                    
                    // Touch events for timeline
                    this.timeline.addEventListener('touchstart', (e) => {
                        isDraggingTimeline = true;
                        this.updateTimelinePosition(e.touches[0]);
                    });
                    
                    document.addEventListener('touchmove', (e) => {
                        if (isDraggingTimeline) {
                            e.preventDefault();
                            this.updateTimelinePosition(e.touches[0]);
                        }
                    }, { passive: false });
                    
                    document.addEventListener('touchend', () => {
                        isDraggingTimeline = false;
                    });
                    
                    // Volume button
                    this.volumeBtn.addEventListener('click', () => {
                        this.toggleMute();
                    });
                    
                    // Volume slider
                    this.volumeSlider.addEventListener('input', () => {
                        const volume = this.volumeSlider.value / 100;
                        this.setVolume(volume);
                    });
                    
                    // Playlist toggle
                    this.playlistToggle.addEventListener('click', () => {
                        this.playlistContainer.classList.toggle('open');
                    });
                    
                    // Repeat playlist button
                    this.repeatPlaylistBtn.addEventListener('click', () => {
                        this.repeatPlaylist = !this.repeatPlaylist;
                        if (this.repeatPlaylist) {
                            this.repeatPlaylistBtn.classList.add('active');
                            showToast('Playlist repeat enabled');
                            // Disable repeat one if it's enabled
                            if (this.repeatOne) {
                                this.repeatOne = false;
                                this.repeatOneBtn.classList.remove('active');
                            }
                        } else {
                            this.repeatPlaylistBtn.classList.remove('active');
                            showToast('Playlist repeat disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Repeat one button
                    this.repeatOneBtn.addEventListener('click', () => {
                        this.repeatOne = !this.repeatOne;
                        if (this.repeatOne) {
                            this.repeatOneBtn.classList.add('active');
                            showToast('Repeat current media enabled');
                            // Disable repeat playlist if it's enabled
                            if (this.repeatPlaylist) {
                                this.repeatPlaylist = false;
                                this.repeatPlaylistBtn.classList.remove('active');
                            }
                        } else {
                            this.repeatOneBtn.classList.remove('active');
                            showToast('Repeat current media disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Shuffle button
                    this.shuffleBtn.addEventListener('click', () => {
                        this.shuffle = !this.shuffle;
                        if (this.shuffle) {
                            this.shuffleBtn.classList.add('active');
                            showToast('Shuffle enabled');
                        } else {
                            this.shuffleBtn.classList.remove('active');
                            showToast('Shuffle disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Settings toggle
                    this.settingsToggle.addEventListener('click', () => {
                        $('#settings-modal').classList.add('open');
                    });
                    
                    // Add URL button
                    $('#add-url-btn').addEventListener('click', () => {
                        const url = $('#new-url').value.trim();
                        const type = $('#url-type').value;
                        const title = $('#url-title').value.trim() || this.getFilenameFromUrl(url);
                        
                        if (url && type) {
                            this.addMedia({ url, type, title });
                            $('#new-url').value = '';
                            $('#url-title').value = '';
                            $('#url-type').value = '';
                            showToast('Media added to playlist');
                        } else {
                            showToast('Please enter URL and select type');
                        }
                    });
                    
                    // Visualizer settings
                    $$('input[name="visualizer-type"]').forEach(input => {
                        input.addEventListener('change', () => {
                            this.visualizerType = input.value;
                            
                            // Reset particles if needed
                            if (this.visualizerType === 'particles') {
                                this.initParticles();
                            }
                        });
                    });
                    
                    $('#visualizer-color').addEventListener('input', () => {
                        this.visualizerColor = $('#visualizer-color').value;
                    });
                    
                    $('#show-audio-info').addEventListener('change', () => {
                        this.showAudioInfo = $('#show-audio-info').checked;
                        if (this.showAudioInfo) {
                            this.audioInfoOverlay.classList.remove('hidden');
                        } else {
                            this.audioInfoOverlay.classList.add('hidden');
                        }
                    });
                    
                    // Space bar to play/pause
                    document.addEventListener('keydown', (e) => {
                        if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                            e.preventDefault();
                            this.togglePlay();
                        }
                    });
                    
                    // Double click to toggle fullscreen
                    this.videoScreen.addEventListener('dblclick', () => {
                        this.toggleFullscreen();
                    });
                },
                
                setupUrlTypeDetection: function() {
                    const urlInput = $('#new-url');
                    const typeSelect = $('#url-type');
                    
                    urlInput.addEventListener('blur', () => {
                        const url = urlInput.value.trim();
                        if (!url) return;
                        
                        // Auto-detect URL type
                        let detectedType = '';
                        
                        if (url.includes('youtube.com') || url.includes('youtu.be')) {
                            detectedType = 'youtube';
                        } else if (url.endsWith('.mp3')) {
                            detectedType = 'mp3';
                        } else if (url.endsWith('.wav')) {
                            detectedType = 'wav';
                        } else if (url.endsWith('.flac')) {
                            detectedType = 'flac';
                        } else if (url.endsWith('.mp4')) {
                            detectedType = 'mp4';
                        } else if (url.endsWith('.gif')) {
                            detectedType = 'gif';
                        }
                        
                        if (detectedType) {
                            typeSelect.value = detectedType;
                            showToast(`Detected: ${detectedType}`);
                        }
                    });
                },
                
                updateTimelinePosition: function(e) {
                    if (!this.mediaElement) {
                        return;
                    }
                    
                    const rect = this.timeline.getBoundingClientRect();
                    let pos = (e.clientX - rect.left) / rect.width;
                    
                    // Clamp values between 0 and 1
                    pos = Math.max(0, Math.min(1, pos));
                    
                    if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            const duration = this.ytPlayer.getDuration();
                            if (duration && typeof this.ytPlayer.seekTo === 'function') {
                                const seekTime = duration * pos;
                                this.ytPlayer.seekTo(seekTime, true);
                                
                                // Update UI immediately to appear responsive
                                this.timelineProgress.style.width = `${pos * 100}%`;
                                const currentTimeFormatted = this.formatTime(seekTime);
                                const durationFormatted = this.formatTime(duration);
                                this.timeDisplay.textContent = `${currentTimeFormatted} / ${durationFormatted}`;
                            }
                        } catch (e) {
                            console.error('Error seeking YouTube video:', e);
                        }
                    } else if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        // For HTML5 media elements
                        this.mediaElement.currentTime = this.mediaElement.duration * pos;
                        this.updateProgress();
                    }
                },
                
                toggleFullscreen: function() {
                    const container = this.container;
                    
                    if (!document.fullscreenElement) {
                        if (container.requestFullscreen) {
                            container.requestFullscreen();
                        } else if (container.webkitRequestFullscreen) {
                            container.webkitRequestFullscreen();
                        } else if (container.msRequestFullscreen) {
                            container.msRequestFullscreen();
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                    }
                },
                
                loadPlaylist: function() {
                    const savedPlaylist = localStorage.getItem('mediaPlaylist');
                    if (savedPlaylist) {
                        try {
                            this.playlist = JSON.parse(savedPlaylist);
                        } catch (e) {
                            console.error('Error parsing playlist:', e);
                            this.playlist = [];
                        }
                    }
                },
                
                savePlaylist: function() {
                    try {
                        localStorage.setItem('mediaPlaylist', JSON.stringify(this.playlist));
                    } catch (e) {
                        console.error('Error saving playlist:', e);
                        showToast('Error saving playlist');
                    }
                },
                
                renderPlaylist: function() {
                    // Render playlist items
                    this.playlistContainer.innerHTML = '';
                    
                    if (this.playlist.length === 0) {
                        this.playlistContainer.innerHTML = '<div style="padding: 10px; text-align: center;">Playlist is empty</div>';
                        return;
                    }
                    
                    this.playlist.forEach((item, index) => {
                        const playlistItem = document.createElement('div');
                        playlistItem.classList.add('playlist-item');
                        if (index === this.currentIndex) {
                            playlistItem.classList.add('active');
                        }
                        
                        playlistItem.innerHTML = `
                            <div class="playlist-item-drag">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                                </svg>
                            </div>
                            <div class="playlist-item-info">${item.title || this.getFilenameFromUrl(item.url)}</div>
                            <div class="playlist-item-type">${this.getTypeLabel(item.type)}</div>
                        `;
                        
                        playlistItem.addEventListener('click', () => {
                            this.currentIndex = index;
                            this.loadMedia();
                            this.renderPlaylist();
                        });
                        
                        this.playlistContainer.appendChild(playlistItem);
                    });
                    
                    // Render URL lists in settings
                    this.renderUrlLists();
                    
                    // Make playlist items draggable
                    this.setupDragAndDrop();
                },
                
                renderUrlLists: function() {
                    // YouTube URLs
                    const youtubeUrls = this.playlist.filter(item => 
                        item.type === 'youtube' || item.type === 'youtube-playlist'
                    );
                    $('.youtube-urls').innerHTML = youtubeUrls.length > 0 ? 
                        youtubeUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No YouTube URLs added yet</div>';
                    
                    // Audio URLs
                    const audioUrls = this.playlist.filter(item => 
                        item.type === 'mp3' || item.type === 'wav' || item.type === 'flac'
                    );
                    $('.audio-urls').innerHTML = audioUrls.length > 0 ? 
                        audioUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No audio URLs added yet</div>';
                    
                    // Video URLs
                    const videoUrls = this.playlist.filter(item => 
                        item.type === 'mp4'
                    );
                    $('.video-urls').innerHTML = videoUrls.length > 0 ? 
                        videoUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No video URLs added yet</div>';
                    
                    // Image URLs
                    const imageUrls = this.playlist.filter(item => 
                        item.type === 'gif'
                    );
                    $('.image-urls').innerHTML = imageUrls.length > 0 ? 
                        imageUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No image URLs added yet</div>';
                    
                    // Setup delete buttons
                    $$('.url-delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeMedia(index);
                        });
                    });
                    
                    // Setup play now buttons
                    $$('.url-play').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.currentIndex = index;
                            this.loadMedia();
                            this.renderPlaylist();
                        });
                    });
                },
                
                createUrlItem: function(item, index) {
                    return `
                        <div class="url-item">
                            ${item.title || this.getFilenameFromUrl(item.url)}
                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 3px; word-break: break-all;">${item.url}</div>
                            <div class="url-actions">
                                <button class="url-action-btn url-play" data-index="${index}">Play</button>
                                <button class="url-action-btn url-delete" data-index="${index}">Delete</button>
                            </div>
                        </div>
                    `;
                },
                
                setupDragAndDrop: function() {
                    const playlistItems = $$('.playlist-item');
                    let draggedItem = null;
                    
                    playlistItems.forEach(item => {
                        item.setAttribute('draggable', true);
                        
                        item.addEventListener('dragstart', function() {
                            draggedItem = this;
                            setTimeout(() => {
                                this.style.opacity = '0.5';
                            }, 0);
                        });
                        
                        item.addEventListener('dragend', function() {
                            this.style.opacity = '1';
                            draggedItem = null;
                        });
                        
                        item.addEventListener('dragover', function(e) {
                            e.preventDefault();
                        });
                        
                        item.addEventListener('dragenter', function(e) {
                            e.preventDefault();
                            this.style.backgroundColor = '#f0f0f0';
                        });
                        
                        item.addEventListener('dragleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        item.addEventListener('drop', function() {
                            this.style.backgroundColor = '';
                            if (draggedItem !== this) {
                                // Get positions
                                const allItems = Array.from($$('.playlist-item'));
                                const fromIndex = allItems.indexOf(draggedItem);
                                const toIndex = allItems.indexOf(this);
                                
                                // Reorder playlist
                                const movedItem = mediaPlayer.playlist.splice(fromIndex, 1)[0];
                                mediaPlayer.playlist.splice(toIndex, 0, movedItem);
                                
                                // Update current index if needed
                                if (mediaPlayer.currentIndex === fromIndex) {
                                    mediaPlayer.currentIndex = toIndex;
                                } else if (
                                    mediaPlayer.currentIndex > fromIndex && 
                                    mediaPlayer.currentIndex <= toIndex
                                ) {
                                    mediaPlayer.currentIndex--;
                                } else if (
                                    mediaPlayer.currentIndex < fromIndex && 
                                    mediaPlayer.currentIndex >= toIndex
                                ) {
                                    mediaPlayer.currentIndex++;
                                }
                                
                                mediaPlayer.savePlaylist();
                                mediaPlayer.renderPlaylist();
                                showToast('Playlist order updated');
                            }
                        });
                    });
                    
                    // Touch drag and drop for mobile
                    let touchDraggedItem = null;
                    let dragOverItem = null;
                    
                    playlistItems.forEach(item => {
                        const dragHandle = item.querySelector('.playlist-item-drag');
                        
                        dragHandle.addEventListener('touchstart', function(e) {
                            e.stopPropagation();
                            touchDraggedItem = item;
                            item.style.opacity = '0.5';
                        }, { passive: true });
                        
                        item.addEventListener('touchmove', function(e) {
                            if (!touchDraggedItem) return;
                            
                            const touch = e.touches[0];
                            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
                            
                            // Find if we're over another playlist item
                            const overItem = elements.find(el => 
                                el.classList.contains('playlist-item') && el !== touchDraggedItem
                            );
                            
                            // Clear previous dragover
                            if (dragOverItem && dragOverItem !== overItem) {
                                dragOverItem.style.backgroundColor = '';
                            }
                            
                            // Set new dragover
                            if (overItem) {
                                overItem.style.backgroundColor = '#4e2a77';
                                dragOverItem = overItem;
                            }
                        }, { passive: true });
                        
                        item.addEventListener('touchend', function(e) {
                            if (!touchDraggedItem) return;
                            
                            if (dragOverItem) {
                                dragOverItem.style.backgroundColor = '';
                                
                                // Get positions
                                const allItems = Array.from($$('.playlist-item'));
                                const fromIndex = allItems.indexOf(touchDraggedItem);
                                const toIndex = allItems.indexOf(dragOverItem);
                                
                                // Reorder playlist
                                const movedItem = mediaPlayer.playlist.splice(fromIndex, 1)[0];
                                mediaPlayer.playlist.splice(toIndex, 0, movedItem);
                                
                                // Update current index if needed
                                if (mediaPlayer.currentIndex === fromIndex) {
                                    mediaPlayer.currentIndex = toIndex;
                                } else if (
                                    mediaPlayer.currentIndex > fromIndex && 
                                    mediaPlayer.currentIndex <= toIndex
                                ) {
                                    mediaPlayer.currentIndex--;
                                } else if (
                                    mediaPlayer.currentIndex < fromIndex && 
                                    mediaPlayer.currentIndex >= toIndex
                                ) {
                                    mediaPlayer.currentIndex++;
                                }
                                
                                mediaPlayer.savePlaylist();
                                mediaPlayer.renderPlaylist();
                                showToast('Playlist order updated');
                            }
                            
                            touchDraggedItem.style.opacity = '1';
                            touchDraggedItem = null;
                            dragOverItem = null;
                        }, { passive: true });
                        
                        // Cancel drag on touch cancel
                        item.addEventListener('touchcancel', function(e) {
                            if (touchDraggedItem) {
                                touchDraggedItem.style.opacity = '1';
                                touchDraggedItem = null;
                            }
                            
                            if (dragOverItem) {
                                dragOverItem.style.backgroundColor = '';
                                dragOverItem = null;
                            }
                        }, { passive: true });
                    });
                    
                    // Touch drag and drop for mobile
                },
                
                getTypeLabel: function(type) {
                    switch(type) {
                        case 'youtube': return 'YouTube';
                        case 'youtube-playlist': return 'YT Playlist';
                        case 'mp3': return 'MP3';
                        case 'wav': return 'WAV';
                        case 'flac': return 'FLAC';
                        case 'mp4': return 'MP4';
                        case 'gif': return 'GIF';
                        default: return type.toUpperCase();
                    }
                },
                
                getFilenameFromUrl: function(url) {
                    try {
                        const pathname = new URL(url).pathname;
                        const filename = pathname.split('/').pop();
                        return filename || url;
                    } catch (e) {
                        return url;
                    }
                },
                
                addMedia: function(media) {
                    this.playlist.push(media);
                    this.savePlaylist();
                    this.renderPlaylist();
                    
                    // If this is the first item, load it
                    if (this.playlist.length === 1) {
                        this.loadMedia();
                    }
                },
                
                removeMedia: function(index) {
                    this.playlist.splice(index, 1);
                    
                    // Update current index if needed
                    if (this.currentIndex === index) {
                        if (this.playlist.length > 0) {
                            this.currentIndex = 0;
                            this.loadMedia();
                        } else {
                            this.clearMedia();
                        }
                    } else if (this.currentIndex > index) {
                        this.currentIndex--;
                    }
                    
                    this.savePlaylist();
                    this.renderPlaylist();
                    showToast('Media removed from playlist');
                },
                
                loadMedia: function() {
                    // Stop current media
                    this.stopMedia();
                    
                    if (this.playlist.length === 0 || this.currentIndex >= this.playlist.length) {
                        return;
                    }
                    
                    const media = this.playlist[this.currentIndex];
                    this.videoScreen.innerHTML = '';
                    
                    // Create audioInfoOverlay
                    const audioInfoOverlay = document.createElement('div');
                    audioInfoOverlay.classList.add('audio-info-overlay');
                    if (!this.showAudioInfo) {
                        audioInfoOverlay.classList.add('hidden');
                    }
                    audioInfoOverlay.innerHTML = `
                        <h3 class="audio-title">${media.title || this.getFilenameFromUrl(media.url)}</h3>
                        <p class="audio-url">${media.url}</p>
                    `;
                    this.audioInfoOverlay = audioInfoOverlay;
                    this.videoScreen.appendChild(audioInfoOverlay);
                    
                    // Create visualizer container
                    const visualizerContainer = document.createElement('div');
                    visualizerContainer.classList.add('visualizer-container');
                    visualizerContainer.innerHTML = `<canvas class="visualizer-canvas"></canvas>`;
                    this.visualizerCanvas = visualizerContainer.querySelector('.visualizer-canvas');
                    this.videoScreen.appendChild(visualizerContainer);
                    
                    // Setup visualizer again
                    this.setupVisualizer();
                    
                    if (media.type === 'youtube' || media.type === 'youtube-playlist') {
                        this.loadYouTubeVideo(media.url);
                    } else if (media.type === 'mp3' || media.type === 'wav' || media.type === 'flac') {
                        this.loadAudio(media.url, media.title);
                    } else if (media.type === 'mp4') {
                        this.loadVideo(media.url);
                    } else if (media.type === 'gif') {
                        this.loadImage(media.url);
                    }
                    
                    // Update playlist
                    this.renderPlaylist();
                },
                
                stopMedia: function() {
                    // Cancel any animation frame
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    
                    // Stop any YouTube progress timer
                    this.stopYouTubeProgressTimer();
                    
                    // Stop YouTube player if exists
                    if (this.ytPlayer && typeof this.ytPlayer.stopVideo === 'function') {
                        try {
                            this.ytPlayer.stopVideo();
                        } catch (e) {
                            console.error('Error stopping YouTube video:', e);
                        }
                    }
                    
                    // Stop any playing media
                    if (this.mediaElement) {
                        if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                            this.mediaElement.pause();
                            this.mediaElement.src = '';
                            this.mediaElement.load();
                        }
                        this.mediaElement = null;
                    }
                    
                    this.ytPlayer = null;
                    this.isPlaying = false;
                    this.updatePlayPauseButton(false);
                },
                
                loadYouTubeVideo: function(url) {
                    const videoId = this.getYouTubeVideoId(url);
                    if (!videoId) {
                        showToast('Invalid YouTube URL');
                        return;
                    }
                    
                    // Create iframe for YouTube with API enabled
                    const iframe = document.createElement('iframe');
                    iframe.classList.add('video-element');
                    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1&origin=${window.location.origin}&controls=0`;
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    iframe.allowFullscreen = true;
                    iframe.id = 'youtube-player';
                    
                    // Hide audio info for YouTube videos
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for YouTube videos
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add iframe to video screen
                    this.videoScreen.appendChild(iframe);
                    
                    // Add loading indicator
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.style.position = 'absolute';
                    loadingIndicator.style.top = '50%';
                    loadingIndicator.style.left = '50%';
                    loadingIndicator.style.transform = 'translate(-50%, -50%)';
                    loadingIndicator.style.zIndex = '98';
                    loadingIndicator.innerHTML = '<div class="spinner"></div><div style="margin-top:10px;color:white;">Loading YouTube video...</div>';
                    this.videoScreen.appendChild(loadingIndicator);
                    
                    // Set as current media element
                    this.mediaElement = iframe;
                    this.isPlaying = true;
                    this.updatePlayPauseButton(true);
                    
                    // Initialize YouTube API for controls
                    if (window.YT && YT.Player) {
                        this.initYouTubePlayer(iframe);
                        // Remove loading indicator after a short delay
                        setTimeout(() => loadingIndicator.remove(), 2000);
                    } else {
                        // Load YouTube API if not already loaded
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        const firstScriptTag = document.getElementsByTagName('script')[0];
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                        
                        // Setup callback when API is ready
                        window.onYouTubeIframeAPIReady = () => {
                            this.initYouTubePlayer(iframe);
                            // Remove loading indicator
                            loadingIndicator.remove();
                        };
                    }
                },
                
                initYouTubePlayer: function(iframe) {
                    this.ytPlayer = new YT.Player(iframe.id, {
                        events: {
                            'onReady': (event) => {
                                // Update timeline when loaded
                                this.updateYouTubeProgress();
                                // Store player reference
                                this.ytPlayer = event.target;
                                // Explicitly play video when player is ready
                                this.ytPlayer.playVideo();
                                
                                // Unmute the video after a short delay to ensure it starts playing
                                setTimeout(() => {
                                    if (this.ytPlayer && typeof this.ytPlayer.unMute === 'function') {
                                        this.ytPlayer.unMute();
                                        this.updateYouTubeVolumeUI();
                                        showToast('YouTube video unmuted');
                                    }
                                }, 1500);
                                
                                // More robust autoplay approach with multiple attempts
                                const attemptAutoplay = () => {
                                    this.ytPlayer.playVideo();
                                    
                                    // Create iframe overlay for better click interaction
                                    const overlay = document.createElement('div');
                                    overlay.style.position = 'absolute';
                                    overlay.style.top = '0';
                                    overlay.style.left = '0';
                                    overlay.style.width = '100%';
                                    overlay.style.height = '100%';
                                    overlay.style.zIndex = '99';
                                    overlay.style.cursor = 'pointer';
                                    
                                    // Add overlay to video screen
                                    this.videoScreen.appendChild(overlay);
                                    
                                    // Simulate multiple interaction methods
                                    const clickEvent = new MouseEvent('click', {
                                        bubbles: true,
                                        cancelable: true,
                                        view: window
                                    });
                                    iframe.dispatchEvent(clickEvent);
                                    overlay.dispatchEvent(clickEvent);
                                    
                                    // Also try touching/pressing
                                    const touchEvent = new TouchEvent('touchstart', {
                                        bubbles: true,
                                        cancelable: true,
                                        view: window
                                    });
                                    iframe.dispatchEvent(touchEvent);
                                    overlay.dispatchEvent(touchEvent);
                                    
                                    // Create and show click animation
                                    const clickAnimation = document.createElement('div');
                                    clickAnimation.style.position = 'absolute';
                                    clickAnimation.style.top = '50%';
                                    clickAnimation.style.left = '50%';
                                    clickAnimation.style.width = '60px';
                                    clickAnimation.style.height = '60px';
                                    clickAnimation.style.marginLeft = '-30px';
                                    clickAnimation.style.marginTop = '-30px';
                                    clickAnimation.style.borderRadius = '50%';
                                    clickAnimation.style.border = '3px solid #fff';
                                    clickAnimation.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                                    clickAnimation.style.zIndex = '100';
                                    clickAnimation.style.animation = 'pulse 0.5s ease-out';
                                    
                                    // Add keyframes for the pulse animation if they don't exist
                                    if (!document.querySelector('#pulse-animation')) {
                                        const style = document.createElement('style');
                                        style.id = 'pulse-animation';
                                        style.textContent = `
                                            @keyframes pulse {
                                                0% { transform: scale(0.5); opacity: 1; }
                                                100% { transform: scale(1.5); opacity: 0; }
                                            }
                                        `;
                                        document.head.appendChild(style);
                                    }
                                    
                                    this.videoScreen.appendChild(clickAnimation);
                                    
                                    // Remove animation after it completes
                                    setTimeout(() => {
                                        clickAnimation.remove();
                                    }, 500);
                                    
                                    // Create a direct play button overlay for user to click if autoplay fails
                                    const playButton = document.createElement('button');
                                    playButton.style.position = 'absolute';
                                    playButton.style.top = '50%';
                                    playButton.style.left = '50%';
                                    playButton.style.transform = 'translate(-50%, -50%)';
                                    playButton.style.zIndex = '101';
                                    playButton.style.padding = '15px 30px';
                                    playButton.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                                    playButton.style.color = 'white';
                                    playButton.style.border = '2px solid white';
                                    playButton.style.borderRadius = '5px';
                                    playButton.style.fontSize = '16px';
                                    playButton.style.cursor = 'pointer';
                                    playButton.style.opacity = '0';
                                    playButton.style.transition = 'opacity 0.5s ease-in';
                                    playButton.textContent = 'Click to Play';
                                    
                                    playButton.addEventListener('click', () => {
                                        this.ytPlayer.playVideo();
                                        playButton.remove();
                                        showToast('Starting YouTube video');
                                    });
                                    
                                    this.videoScreen.appendChild(playButton);
                                    
                    // Remove overlay after a short delay
                    setTimeout(() => {
                        overlay.remove();
                    }, 1000);
                    
                    // Check if video is playing after a few seconds, and try to play it again if needed
                    setTimeout(() => {
                        try {
                            const state = this.ytPlayer.getPlayerState();
                            if (state !== YT.PlayerState.PLAYING) {
                                this.ytPlayer.playVideo();
                                showToast('Starting YouTube video');
                            }
                        } catch (e) {
                            console.error('Error checking YouTube player state:', e);
                        }
                    }, 3000);
                            };
                            
                            // Try immediately
                            attemptAutoplay();
                            
                            // Try again after a short delay
                            setTimeout(attemptAutoplay, 2000);
                            
                            showToast('YouTube video loaded');
                        },
                        'onStateChange': (event) => {
                            // Update play/pause button based on state
                            if (event.data === YT.PlayerState.PLAYING) {
                                this.isPlaying = true;
                                this.updatePlayPauseButton(true);
                                this.startYouTubeProgressTimer();
                                showToast('YouTube video playing');
                            } else if (event.data === YT.PlayerState.PAUSED) {
                                this.isPlaying = false;
                                this.updatePlayPauseButton(false);
                                this.stopYouTubeProgressTimer();
                            } else if (event.data === YT.PlayerState.ENDED) {
                                this.playNext();
                            }
                        },
                        'onError': (event) => {
                            console.error('YouTube error:', event.data);
                            showToast('Error loading YouTube video. Try clicking play.');
                        }
                    }
                });
                },
                
                updateYouTubeProgress: function() {
                    if (!this.ytPlayer || typeof this.ytPlayer.getCurrentTime !== 'function') return;
                    
                    try {
                        const currentTime = this.ytPlayer.getCurrentTime() || 0;
                        const duration = this.ytPlayer.getDuration() || 0;
                        
                        if (duration > 0) {
                            const progress = (currentTime / duration) * 100;
                            this.timelineProgress.style.width = `${progress}%`;
                            
                            // Update time display
                            const currentTimeFormatted = this.formatTime(currentTime);
                            const durationFormatted = this.formatTime(duration);
                            this.timeDisplay.textContent = `${currentTimeFormatted} / ${durationFormatted}`;
                        }
                    } catch (e) {
                        console.error('Error updating YouTube progress:', e);
                    }
                },
                
                startYouTubeProgressTimer: function() {
                    this.stopYouTubeProgressTimer();
                    this.youtubeProgressTimer = setInterval(() => {
                        this.updateYouTubeProgress();
                    }, 500);
                },
                
                stopYouTubeProgressTimer: function() {
                    if (this.youtubeProgressTimer) {
                        clearInterval(this.youtubeProgressTimer);
                        this.youtubeProgressTimer = null;
                    }
                },
                
                togglePlay: function() {
                    if (!this.mediaElement) {
                        if (this.playlist.length > 0) {
                            this.loadMedia();
                        }
                        return;
                    }
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        if (this.isPlaying) {
                            this.mediaElement.pause();
                            this.isPlaying = false;
                            showToast('Paused');
                        } else {
                            this.mediaElement.play()
                                .then(() => {
                                    this.isPlaying = true;
                                    showToast('Playing');
                                })
                                .catch((error) => {
                                    console.error('Error playing media:', error);
                                    this.isPlaying = false;
                                    showToast('Error playing media. Try again.');
                                });
                        }
                        this.updatePlayPauseButton(this.isPlaying);
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // Control YouTube player
                        try {
                            const state = this.ytPlayer.getPlayerState();
                            if (state === YT.PlayerState.PLAYING) {
                                this.ytPlayer.pauseVideo();
                                this.isPlaying = false;
                                showToast('Paused');
                            } else {
                                this.ytPlayer.playVideo();
                                this.isPlaying = true;
                                showToast('Playing');
                            }
                            this.updatePlayPauseButton(this.isPlaying);
                        } catch (e) {
                            console.error('Error controlling YouTube:', e);
                            showToast('Error controlling YouTube player');
                        }
                    }
                },
                
                playPrevious: function() {
                    if (this.currentIndex <= 0) return;
                    
                    this.currentIndex--;
                    this.loadMedia();
                },
                
                playNext: function() {
                    if (this.repeatOne) {
                        // Just reload the current media
                        this.loadMedia();
                        return;
                    }
                    
                    if (this.shuffle) {
                        // Pick a random index that's not the current one
                        if (this.playlist.length > 1) {
                            let newIndex = this.currentIndex;
                            while (newIndex === this.currentIndex) {
                                newIndex = Math.floor(Math.random() * this.playlist.length);
                            }
                            this.currentIndex = newIndex;
                        }
                    } else {
                        // Normal sequential playback
                        if (this.currentIndex >= this.playlist.length - 1) {
                            if (this.repeatPlaylist) {
                                this.currentIndex = 0;
                            } else {
                                return; // End of playlist
                            }
                        } else {
                            this.currentIndex++;
                        }
                    }
                    
                    this.loadMedia();
                },
                
                updatePlayPauseButton: function(isPlaying) {
                    if (isPlaying) {
                        this.playIcon.style.display = 'none';
                        this.pauseIcon.style.display = 'block';
                    } else {
                        this.playIcon.style.display = 'block';
                        this.pauseIcon.style.display = 'none';
                    }
                },
                
                getYouTubeVideoId: function(url) {
                    try {
                        const urlObj = new URL(url);
                        if (url.includes('youtube.com')) {
                            return urlObj.searchParams.get('v') || '';
                        } else if (url.includes('youtu.be')) {
                            return urlObj.pathname.substring(1);
                        }
                    } catch (e) {
                        return '';
                    }
                    return '';
                },
                
                updateProgress: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    const progress = (this.mediaElement.currentTime / this.mediaElement.duration) * 100;
                    this.timelineProgress.style.width = `${progress}%`;
                },
                
                updateTimeDisplay: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    const currentTime = this.formatTime(this.mediaElement.currentTime);
                    const duration = this.formatTime(this.mediaElement.duration);
                    this.timeDisplay.textContent = `${currentTime} / ${duration}`;
                },
                
                updateBuffer: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    if (this.mediaElement.buffered.length > 0) {
                        const bufferedEnd = this.mediaElement.buffered.end(this.mediaElement.buffered.length - 1);
                        const duration = this.mediaElement.duration;
                        const bufferedPercent = (bufferedEnd / duration) * 100;
                        this.timelineBuffer.style.width = `${bufferedPercent}%`;
                    }
                },
                
                formatTime: function(seconds) {
                    if (isNaN(seconds)) return '0:00';
                    
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
                },
                
                loadAudio: function(url, title) {
                    // Create audio element
                    const audio = document.createElement('audio');
                    audio.classList.add('audio-element');
                    audio.crossOrigin = 'anonymous'; // For visualizer to work with remote audio
                    audio.src = url;
                    audio.controls = false;
                    
                    // Update audio info
                    this.audioInfoOverlay.querySelector('.audio-title').textContent = title || this.getFilenameFromUrl(url);
                    this.audioInfoOverlay.querySelector('.audio-url').textContent = url;
                    this.audioInfoOverlay.classList.remove('hidden');
                    
                    // Show visualizer
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'block';
                    }
                    
                    // Add audio to video screen
                    this.videoScreen.appendChild(audio);
                    
                    // Setup audio context for visualizer
                    if (this.audioContext && !this.audioContext.closed) {
                        this.audioContext.close();
                    }
                    
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 256;
                        
                        const source = this.audioContext.createMediaElementSource(audio);
                        source.connect(this.analyser);
                        this.analyser.connect(this.audioContext.destination);
                        
                        // Start visualizer
                        this.startVisualizer();
                    } catch (e) {
                        console.error('Error setting up audio visualizer:', e);
                    }
                    
                    // Set as current media element
                    this.mediaElement = audio;
                    
                    // Setup event listeners
                    audio.addEventListener('timeupdate', () => {
                        this.updateTimeDisplay();
                        this.updateProgress();
                    });
                    
                    audio.addEventListener('progress', () => {
                        this.updateBuffer();
                    });
                    
                    audio.addEventListener('ended', () => {
                        this.playNext();
                    });
                    
                    // Auto play
                    audio.play()
                        .then(() => {
                            this.isPlaying = true;
                            this.updatePlayPauseButton(true);
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            this.isPlaying = false;
                            this.updatePlayPauseButton(false);
                            showToast('Click play to start audio');
                        });
                },
                
                loadVideo: function(url) {
                    // Create video element
                    const video = document.createElement('video');
                    video.classList.add('video-element');
                    video.src = url;
                    video.controls = false;
                    video.playsInline = true;
                    
                    // Hide audio info for videos
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for videos
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add video to video screen
                    this.videoScreen.appendChild(video);
                    
                    // Set as current media element
                    this.mediaElement = video;
                    
                    // Setup event listeners
                    video.addEventListener('timeupdate', () => {
                        this.updateTimeDisplay();
                        this.updateProgress();
                    });
                    
                    video.addEventListener('progress', () => {
                        this.updateBuffer();
                    });
                    
                    video.addEventListener('ended', () => {
                        this.playNext();
                    });
                    
                    // Auto play
                    video.play()
                        .then(() => {
                            this.isPlaying = true;
                            this.updatePlayPauseButton(true);
                        })
                        .catch(error => {
                            console.error('Error playing video:', error);
                            this.isPlaying = false;
                            this.updatePlayPauseButton(false);
                            showToast('Click play to start video');
                        });
                },
                
                loadImage: function(url) {
                    // Create image element
                    const img = document.createElement('img');
                    img.classList.add('video-element');
                    img.src = url;
                    img.alt = this.getFilenameFromUrl(url);
                    
                    // Hide audio info for images
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for images
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add image to video screen
                    this.videoScreen.appendChild(img);
                    
                    // Set as current media element but don't try to play it
                    this.mediaElement = img;
                    this.isPlaying = true;
                    this.updatePlayPauseButton(true);
                    
                    // Reset timeline
                    this.timeDisplay.textContent = '';
                    this.timelineProgress.style.width = '0%';
                },
                
                toggleMute: function() {
                    if (!this.mediaElement) return;
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        this.mediaElement.muted = !this.mediaElement.muted;
                        this.updateVolumeUI();
                        
                        showToast(this.mediaElement.muted ? 'Muted' : 'Unmuted');
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            const isMuted = this.ytPlayer.isMuted();
                            if (isMuted) {
                                this.ytPlayer.unMute();
                                showToast('Unmuted');
                            } else {
                                this.ytPlayer.mute();
                                showToast('Muted');
                            }
                            
                            // Update UI
                            setTimeout(() => this.updateYouTubeVolumeUI(), 100);
                        } catch (e) {
                            console.error('Error toggling YouTube mute:', e);
                        }
                    }
                },
                
                updateYouTubeVolumeUI: function() {
                    if (!this.ytPlayer) return;
                    
                    try {
                        const isMuted = this.ytPlayer.isMuted();
                        const volume = this.ytPlayer.getVolume() / 100;
                        
                        if (isMuted || volume === 0) {
                            this.volumeHighIcon.style.display = 'none';
                            this.volumeMuteIcon.style.display = 'block';
                        } else {
                            this.volumeHighIcon.style.display = 'block';
                            this.volumeMuteIcon.style.display = 'none';
                        }
                        
                        this.volumeSlider.value = isMuted ? 0 : volume * 100;
                    } catch (e) {
                        console.error('Error updating YouTube volume UI:', e);
                    }
                },
                
                setVolume: function(volume) {
                    if (!this.mediaElement) return;
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        this.mediaElement.volume = volume;
                        this.mediaElement.muted = volume === 0;
                        this.updateVolumeUI();
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            this.ytPlayer.setVolume(volume * 100);
                            
                            if (volume === 0) {
                                this.ytPlayer.mute();
                            } else if (this.ytPlayer.isMuted()) {
                                this.ytPlayer.unMute();
                            }
                            
                            this.updateYouTubeVolumeUI();
                        } catch (e) {
                            console.error('Error setting YouTube volume:', e);
                        }
                    }
                },
                
                startVisualizer: function() {
                    // Start animation loop
                    this.animationId = requestAnimationFrame(() => {
                        this.updateVisualizer();
                        this.startVisualizer();
                    });
                },
                
                updateVisualizer: function() {
                    // Clear canvas
                    const ctx = this.visualizerCanvas.getContext('2d');
                    ctx.clearRect(0, 0, this.visualizerCanvas.width, this.visualizerCanvas.height);
                    
                    // Draw based on visualizer type
                    if (this.visualizerType === 'bars') {
                        const frequencyData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(frequencyData);
                        
                        const barWidth = this.visualizerCanvas.width / frequencyData.length;
                        const barHeightScale = this.visualizerCanvas.height / 256;
                        
                        ctx.fillStyle = this.visualizerColor;
                        frequencyData.forEach((value, index) => {
                            ctx.fillRect(index * barWidth, this.visualizerCanvas.height - value * barHeightScale, barWidth, value * barHeightScale);
                        });
                    } else if (this.visualizerType === 'wave') {
                        const timeDomainData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteTimeDomainData(timeDomainData);
                        
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = this.visualizerColor;
                        ctx.moveTo(0, this.visualizerCanvas.height / 2);
                        timeDomainData.forEach((value, index) => {
                            const x = index * this.visualizerCanvas.width / timeDomainData.length;
                            const y = this.visualizerCanvas.height / 2 + value * (this.visualizerCanvas.height / 2) / 128;
                            ctx.lineTo(x, y);
                        });
                        ctx.stroke();
                    } else if (this.visualizerType === 'circle') {
                        const frequencyData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(frequencyData);
                        
                        const radiusScale = this.visualizerCanvas.width / 2 / 256;
                        ctx.fillStyle = this.visualizerColor;
                        frequencyData.forEach((value, index) => {
                            const radius = value * radiusScale;
                            ctx.beginPath();
                            ctx.arc(this.visualizerCanvas.width / 2, this.visualizerCanvas.height / 2, radius, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                    } else if (this.visualizerType === 'particles') {
                        // Particles visualizer is not implemented yet
                    }
                },
                setupVisualizer: function() {
                    if (!this.visualizerCanvas) {
                        this.visualizerCanvas = $('.visualizer-canvas');
                        if (!this.visualizerCanvas) {
                            console.error('Could not find visualizer canvas');
                            return;
                        }
                    }
                    
                    // Set canvas dimensions to match container
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        const rect = visualizerContainer.getBoundingClientRect();
                        this.visualizerCanvas.width = rect.width;
                        this.visualizerCanvas.height = rect.height;
                    }
                    
                    // Initialize particles if using particle visualizer
                    if (this.visualizerType === 'particles') {
                        this.initParticles();
                    }
                },
                
                initParticles: function() {
                    // Initialize particles for particle visualizer
                    this.particles = [];
                    const particleCount = 100;
                    
                    for (let i = 0; i < particleCount; i++) {
                        this.particles.push({
                            x: Math.random() * this.visualizerCanvas.width,
                            y: Math.random() * this.visualizerCanvas.height,
                            radius: Math.random() * 3 + 1,
                            color: this.visualizerColor,
                            velocity: {
                                x: Math.random() * 2 - 1,
                                y: Math.random() * 2 - 1
                            }
                        });
                    }
                },
                
                addSampleMedia: function() {
                    this.addMedia({
                        title: 'Sample Audio',
                        url: 'https://file-examples.com/storage/fe03757fe963b144a93c637/2017/11/file_example_MP3_700KB.mp3',
                        type: 'mp3'
                    });
                },
                
                savePlaybackSettings: function() {
                    try {
                        const settings = {
                            repeatPlaylist: this.repeatPlaylist,
                            repeatOne: this.repeatOne,
                            shuffle: this.shuffle
                        };
                        localStorage.setItem('mediaPlaybackSettings', JSON.stringify(settings));
                    } catch (e) {
                        console.error('Error saving playback settings:', e);
                    }
                },
                
                loadPlaybackSettings: function() {
                    try {
                        const savedSettings = localStorage.getItem('mediaPlaybackSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            this.repeatPlaylist = settings.repeatPlaylist || false;
                            this.repeatOne = settings.repeatOne || false;
                            this.shuffle = settings.shuffle || false;
                            
                            // Update UI to match
                            if (this.repeatPlaylist) {
                                this.repeatPlaylistBtn.classList.add('active');
                            }
                            if (this.repeatOne) {
                                this.repeatOneBtn.classList.add('active');
                            }
                            if (this.shuffle) {
                                this.shuffleBtn.classList.add('active');
                            }
                        }
                    } catch (e) {
                        console.error('Error loading playback settings:', e);
                    }
                }
            };
            
            window.mediaPlayer = {
                container: $('.media-player'),
                videoScreen: $('.video-screen'),
                audioInfoOverlay: null,
                visualizerCanvas: null,
                playPauseBtn: $('.play-pause-btn'),
                playIcon: $('.play-icon'),
                pauseIcon: $('.pause-icon'),
                prevBtn: $('.prev-btn'),
                nextBtn: $('.next-btn'),
                timeDisplay: $('.time-display'),
                timeline: $('.timeline'),
                timelineProgress: $('.timeline-progress'),
                timelineBuffer: $('.timeline-buffer'),
                volumeBtn: $('.volume-btn'),
                volumeHighIcon: $('.volume-high-icon'),
                volumeMuteIcon: $('.volume-mute-icon'),
                volumeSlider: $('.volume-slider'),
                playlistToggle: $('.playlist-toggle'),
                repeatPlaylistBtn: $('.repeat-playlist-btn'),
                repeatOneBtn: $('.repeat-one-btn'),
                shuffleBtn: $('.shuffle-btn'),
                settingsToggle: $('.settings-toggle'),
                playlistContainer: $('.playlist-container'),
                playlist: [],
                currentIndex: 0,
                audioContext: null,
                analyser: null,
                mediaElement: null,
                visualizerType: 'bars',
                visualizerColor: '#3498db',
                showAudioInfo: true,
                isPlaying: false,
                animationId: null,
                particles: [],
                ytPlayer: null,
                youtubeProgressTimer: null,
                repeatPlaylist: false,
                repeatOne: false,
                shuffle: false,
                
                init: function() {
                    // Make sure we have all required elements
                    this.ensureElements();
                    
                    // Load playlist from localStorage
                    this.loadPlaylist();
                    
                    // Initialize audio context for visualizer
                    this.initAudioContext();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Render playlist
                    this.renderPlaylist();
                    
                    // Setup visualizer
                    this.setupVisualizer();
                    
                    // Add some sample media
                    if (this.playlist.length === 0) {
                        this.addSampleMedia();
                    }
                    
                    // Auto detect URL type
                    this.setupUrlTypeDetection();
                    
                    // Load playback settings
                    this.loadPlaybackSettings();
                },
                
                ensureElements: function() {
                    // Create audio info overlay if it doesn't exist
                    if (!this.audioInfoOverlay) {
                        this.audioInfoOverlay = document.createElement('div');
                        this.audioInfoOverlay.classList.add('audio-info-overlay');
                        if (!this.showAudioInfo) {
                            this.audioInfoOverlay.classList.add('hidden');
                        }
                        this.audioInfoOverlay.innerHTML = `
                            <h3 class="audio-title">No Audio Playing</h3>
                            <p class="audio-url">No URL</p>
                        `;
                        this.videoScreen.appendChild(this.audioInfoOverlay);
                    }
                    
                    // Create visualizer container and canvas if needed
                    if (!document.querySelector('.visualizer-container')) {
                        const visualizerContainer = document.createElement('div');
                        visualizerContainer.classList.add('visualizer-container');
                        const canvas = document.createElement('canvas');
                        canvas.classList.add('visualizer-canvas');
                        visualizerContainer.appendChild(canvas);
                        this.videoScreen.appendChild(visualizerContainer);
                        this.visualizerCanvas = canvas;
                    } else if (!this.visualizerCanvas) {
                        this.visualizerCanvas = $('.visualizer-canvas');
                        
                        if (!this.visualizerCanvas) {
                            console.error('Could not create visualizer canvas');
                            return;
                        }
                    }
                },
                
                initAudioContext: function() {
                    try {
                        window.AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioContext = new AudioContext();
                    } catch (e) {
                        console.warn('Web Audio API is not supported in this browser');
                    }
                },
                
                setupEventListeners: function() {
                    // Play/Pause button
                    this.playPauseBtn.addEventListener('click', () => {
                        this.togglePlay();
                    });
                    
                    // Previous button
                    this.prevBtn.addEventListener('click', () => {
                        this.playPrevious();
                    });
                    
                    // Next button
                    this.nextBtn.addEventListener('click', () => {
                        this.playNext();
                    });
                    
                    // Timeline - mouse/touch events
                    let isDraggingTimeline = false;
                    
                    this.timeline.addEventListener('mousedown', (e) => {
                        isDraggingTimeline = true;
                        this.updateTimelinePosition(e);
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (isDraggingTimeline) {
                            this.updateTimelinePosition(e);
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        isDraggingTimeline = false;
                    });
                    
                    // Touch events for timeline
                    this.timeline.addEventListener('touchstart', (e) => {
                        isDraggingTimeline = true;
                        this.updateTimelinePosition(e.touches[0]);
                    });
                    
                    document.addEventListener('touchmove', (e) => {
                        if (isDraggingTimeline) {
                            e.preventDefault();
                            this.updateTimelinePosition(e.touches[0]);
                        }
                    }, { passive: false });
                    
                    document.addEventListener('touchend', () => {
                        isDraggingTimeline = false;
                    });
                    
                    // Volume button
                    this.volumeBtn.addEventListener('click', () => {
                        this.toggleMute();
                    });
                    
                    // Volume slider
                    this.volumeSlider.addEventListener('input', () => {
                        const volume = this.volumeSlider.value / 100;
                        this.setVolume(volume);
                    });
                    
                    // Playlist toggle
                    this.playlistToggle.addEventListener('click', () => {
                        this.playlistContainer.classList.toggle('open');
                    });
                    
                    // Repeat playlist button
                    this.repeatPlaylistBtn.addEventListener('click', () => {
                        this.repeatPlaylist = !this.repeatPlaylist;
                        if (this.repeatPlaylist) {
                            this.repeatPlaylistBtn.classList.add('active');
                            showToast('Playlist repeat enabled');
                            // Disable repeat one if it's enabled
                            if (this.repeatOne) {
                                this.repeatOne = false;
                                this.repeatOneBtn.classList.remove('active');
                            }
                        } else {
                            this.repeatPlaylistBtn.classList.remove('active');
                            showToast('Playlist repeat disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Repeat one button
                    this.repeatOneBtn.addEventListener('click', () => {
                        this.repeatOne = !this.repeatOne;
                        if (this.repeatOne) {
                            this.repeatOneBtn.classList.add('active');
                            showToast('Repeat current media enabled');
                            // Disable repeat playlist if it's enabled
                            if (this.repeatPlaylist) {
                                this.repeatPlaylist = false;
                                this.repeatPlaylistBtn.classList.remove('active');
                            }
                        } else {
                            this.repeatOneBtn.classList.remove('active');
                            showToast('Repeat current media disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Shuffle button
                    this.shuffleBtn.addEventListener('click', () => {
                        this.shuffle = !this.shuffle;
                        if (this.shuffle) {
                            this.shuffleBtn.classList.add('active');
                            showToast('Shuffle enabled');
                        } else {
                            this.shuffleBtn.classList.remove('active');
                            showToast('Shuffle disabled');
                        }
                        this.savePlaybackSettings();
                    });
                    
                    // Settings toggle
                    this.settingsToggle.addEventListener('click', () => {
                        $('#settings-modal').classList.add('open');
                    });
                    
                    // Add URL button
                    $('#add-url-btn').addEventListener('click', () => {
                        const url = $('#new-url').value.trim();
                        const type = $('#url-type').value;
                        const title = $('#url-title').value.trim() || this.getFilenameFromUrl(url);
                        
                        if (url && type) {
                            this.addMedia({ url, type, title });
                            $('#new-url').value = '';
                            $('#url-title').value = '';
                            $('#url-type').value = '';
                            showToast('Media added to playlist');
                        } else {
                            showToast('Please enter URL and select type');
                        }
                    });
                    
                    // Visualizer settings
                    $$('input[name="visualizer-type"]').forEach(input => {
                        input.addEventListener('change', () => {
                            this.visualizerType = input.value;
                            
                            // Reset particles if needed
                            if (this.visualizerType === 'particles') {
                                this.initParticles();
                            }
                        });
                    });
                    
                    $('#visualizer-color').addEventListener('input', () => {
                        this.visualizerColor = $('#visualizer-color').value;
                    });
                    
                    $('#show-audio-info').addEventListener('change', () => {
                        this.showAudioInfo = $('#show-audio-info').checked;
                        if (this.showAudioInfo) {
                            this.audioInfoOverlay.classList.remove('hidden');
                        } else {
                            this.audioInfoOverlay.classList.add('hidden');
                        }
                    });
                    
                    // Space bar to play/pause
                    document.addEventListener('keydown', (e) => {
                        if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                            e.preventDefault();
                            this.togglePlay();
                        }
                    });
                    
                    // Double click to toggle fullscreen
                    this.videoScreen.addEventListener('dblclick', () => {
                        this.toggleFullscreen();
                    });
                },
                
                setupUrlTypeDetection: function() {
                    const urlInput = $('#new-url');
                    const typeSelect = $('#url-type');
                    
                    urlInput.addEventListener('blur', () => {
                        const url = urlInput.value.trim();
                        if (!url) return;
                        
                        // Auto-detect URL type
                        let detectedType = '';
                        
                        if (url.includes('youtube.com') || url.includes('youtu.be')) {
                            detectedType = 'youtube';
                        } else if (url.endsWith('.mp3')) {
                            detectedType = 'mp3';
                        } else if (url.endsWith('.wav')) {
                            detectedType = 'wav';
                        } else if (url.endsWith('.flac')) {
                            detectedType = 'flac';
                        } else if (url.endsWith('.mp4')) {
                            detectedType = 'mp4';
                        } else if (url.endsWith('.gif')) {
                            detectedType = 'gif';
                        }
                        
                        if (detectedType) {
                            typeSelect.value = detectedType;
                            showToast(`Detected: ${detectedType}`);
                        }
                    });
                },
                
                updateTimelinePosition: function(e) {
                    if (!this.mediaElement) {
                        return;
                    }
                    
                    const rect = this.timeline.getBoundingClientRect();
                    let pos = (e.clientX - rect.left) / rect.width;
                    
                    // Clamp values between 0 and 1
                    pos = Math.max(0, Math.min(1, pos));
                    
                    if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            const duration = this.ytPlayer.getDuration();
                            if (duration && typeof this.ytPlayer.seekTo === 'function') {
                                const seekTime = duration * pos;
                                this.ytPlayer.seekTo(seekTime, true);
                                
                                // Update UI immediately to appear responsive
                                this.timelineProgress.style.width = `${pos * 100}%`;
                                const currentTimeFormatted = this.formatTime(seekTime);
                                const durationFormatted = this.formatTime(duration);
                                this.timeDisplay.textContent = `${currentTimeFormatted} / ${durationFormatted}`;
                            }
                        } catch (e) {
                            console.error('Error seeking YouTube video:', e);
                        }
                    } else if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        // For HTML5 media elements
                        this.mediaElement.currentTime = this.mediaElement.duration * pos;
                        this.updateProgress();
                    }
                },
                
                toggleFullscreen: function() {
                    const container = this.container;
                    
                    if (!document.fullscreenElement) {
                        if (container.requestFullscreen) {
                            container.requestFullscreen();
                        } else if (container.webkitRequestFullscreen) {
                            container.webkitRequestFullscreen();
                        } else if (container.msRequestFullscreen) {
                            container.msRequestFullscreen();
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                    }
                },
                
                loadPlaylist: function() {
                    const savedPlaylist = localStorage.getItem('mediaPlaylist');
                    if (savedPlaylist) {
                        try {
                            this.playlist = JSON.parse(savedPlaylist);
                        } catch (e) {
                            console.error('Error parsing playlist:', e);
                            this.playlist = [];
                        }
                    }
                },
                
                savePlaylist: function() {
                    try {
                        localStorage.setItem('mediaPlaylist', JSON.stringify(this.playlist));
                    } catch (e) {
                        console.error('Error saving playlist:', e);
                        showToast('Error saving playlist');
                    }
                },
                
                renderPlaylist: function() {
                    // Render playlist items
                    this.playlistContainer.innerHTML = '';
                    
                    if (this.playlist.length === 0) {
                        this.playlistContainer.innerHTML = '<div style="padding: 10px; text-align: center;">Playlist is empty</div>';
                        return;
                    }
                    
                    this.playlist.forEach((item, index) => {
                        const playlistItem = document.createElement('div');
                        playlistItem.classList.add('playlist-item');
                        if (index === this.currentIndex) {
                            playlistItem.classList.add('active');
                        }
                        
                        playlistItem.innerHTML = `
                            <div class="playlist-item-drag">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                                </svg>
                            </div>
                            <div class="playlist-item-info">${item.title || this.getFilenameFromUrl(item.url)}</div>
                            <div class="playlist-item-type">${this.getTypeLabel(item.type)}</div>
                        `;
                        
                        playlistItem.addEventListener('click', () => {
                            this.currentIndex = index;
                            this.loadMedia();
                            this.renderPlaylist();
                        });
                        
                        this.playlistContainer.appendChild(playlistItem);
                    });
                    
                    // Render URL lists in settings
                    this.renderUrlLists();
                    
                    // Make playlist items draggable
                    this.setupDragAndDrop();
                },
                
                renderUrlLists: function() {
                    // YouTube URLs
                    const youtubeUrls = this.playlist.filter(item => 
                        item.type === 'youtube' || item.type === 'youtube-playlist'
                    );
                    $('.youtube-urls').innerHTML = youtubeUrls.length > 0 ? 
                        youtubeUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No YouTube URLs added yet</div>';
                    
                    // Audio URLs
                    const audioUrls = this.playlist.filter(item => 
                        item.type === 'mp3' || item.type === 'wav' || item.type === 'flac'
                    );
                    $('.audio-urls').innerHTML = audioUrls.length > 0 ? 
                        audioUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No audio URLs added yet</div>';
                    
                    // Video URLs
                    const videoUrls = this.playlist.filter(item => 
                        item.type === 'mp4'
                    );
                    $('.video-urls').innerHTML = videoUrls.length > 0 ? 
                        videoUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No video URLs added yet</div>';
                    
                    // Image URLs
                    const imageUrls = this.playlist.filter(item => 
                        item.type === 'gif'
                    );
                    $('.image-urls').innerHTML = imageUrls.length > 0 ? 
                        imageUrls.map((item, index) => this.createUrlItem(item, index)).join('') : 
                        '<div class="url-item">No image URLs added yet</div>';
                    
                    // Setup delete buttons
                    $$('.url-delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeMedia(index);
                        });
                    });
                    
                    // Setup play now buttons
                    $$('.url-play').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.currentIndex = index;
                            this.loadMedia();
                            this.renderPlaylist();
                        });
                    });
                },
                
                createUrlItem: function(item, index) {
                    return `
                        <div class="url-item">
                            ${item.title || this.getFilenameFromUrl(item.url)}
                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 3px; word-break: break-all;">${item.url}</div>
                            <div class="url-actions">
                                <button class="url-action-btn url-play" data-index="${index}">Play</button>
                                <button class="url-action-btn url-delete" data-index="${index}">Delete</button>
                            </div>
                        </div>
                    `;
                },
                
                setupDragAndDrop: function() {
                    const playlistItems = $$('.playlist-item');
                    let draggedItem = null;
                    
                    playlistItems.forEach(item => {
                        item.setAttribute('draggable', true);
                        
                        item.addEventListener('dragstart', function() {
                            draggedItem = this;
                            setTimeout(() => {
                                this.style.opacity = '0.5';
                            }, 0);
                        });
                        
                        item.addEventListener('dragend', function() {
                            this.style.opacity = '1';
                            draggedItem = null;
                        });
                        
                        item.addEventListener('dragover', function(e) {
                            e.preventDefault();
                        });
                        
                        item.addEventListener('dragenter', function(e) {
                            e.preventDefault();
                            this.style.backgroundColor = '#f0f0f0';
                        });
                        
                        item.addEventListener('dragleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        item.addEventListener('drop', function() {
                            this.style.backgroundColor = '';
                            if (draggedItem !== this) {
                                // Get positions
                                const allItems = Array.from($$('.playlist-item'));
                                const fromIndex = allItems.indexOf(draggedItem);
                                const toIndex = allItems.indexOf(this);
                                
                                // Reorder playlist
                                const movedItem = mediaPlayer.playlist.splice(fromIndex, 1)[0];
                                mediaPlayer.playlist.splice(toIndex, 0, movedItem);
                                
                                // Update current index if needed
                                if (mediaPlayer.currentIndex === fromIndex) {
                                    mediaPlayer.currentIndex = toIndex;
                                } else if (
                                    mediaPlayer.currentIndex > fromIndex && 
                                    mediaPlayer.currentIndex <= toIndex
                                ) {
                                    mediaPlayer.currentIndex--;
                                } else if (
                                    mediaPlayer.currentIndex < fromIndex && 
                                    mediaPlayer.currentIndex >= toIndex
                                ) {
                                    mediaPlayer.currentIndex++;
                                }
                                
                                mediaPlayer.savePlaylist();
                                mediaPlayer.renderPlaylist();
                                showToast('Playlist order updated');
                            }
                        });
                    });
                    
                    // Touch drag and drop for mobile
                    let touchDraggedItem = null;
                    let dragOverItem = null;
                    
                    playlistItems.forEach(item => {
                        const dragHandle = item.querySelector('.playlist-item-drag');
                        
                        dragHandle.addEventListener('touchstart', function(e) {
                            e.stopPropagation();
                            touchDraggedItem = item;
                            item.style.opacity = '0.5';
                        }, { passive: true });
                        
                        item.addEventListener('touchmove', function(e) {
                            if (!touchDraggedItem) return;
                            
                            const touch = e.touches[0];
                            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
                            
                            // Find if we're over another playlist item
                            const overItem = elements.find(el => 
                                el.classList.contains('playlist-item') && el !== touchDraggedItem
                            );
                            
                            // Clear previous dragover
                            if (dragOverItem && dragOverItem !== overItem) {
                                dragOverItem.style.backgroundColor = '';
                            }
                            
                            // Set new dragover
                            if (overItem) {
                                overItem.style.backgroundColor = '#4e2a77';
                                dragOverItem = overItem;
                            }
                        }, { passive: true });
                        
                        item.addEventListener('touchend', function(e) {
                            if (!touchDraggedItem) return;
                            
                            if (dragOverItem) {
                                dragOverItem.style.backgroundColor = '';
                                
                                // Get positions
                                const allItems = Array.from($$('.playlist-item'));
                                const fromIndex = allItems.indexOf(touchDraggedItem);
                                const toIndex = allItems.indexOf(dragOverItem);
                                
                                // Reorder playlist
                                const movedItem = mediaPlayer.playlist.splice(fromIndex, 1)[0];
                                mediaPlayer.playlist.splice(toIndex, 0, movedItem);
                                
                                // Update current index if needed
                                if (mediaPlayer.currentIndex === fromIndex) {
                                    mediaPlayer.currentIndex = toIndex;
                                } else if (
                                    mediaPlayer.currentIndex > fromIndex && 
                                    mediaPlayer.currentIndex <= toIndex
                                ) {
                                    mediaPlayer.currentIndex--;
                                } else if (
                                    mediaPlayer.currentIndex < fromIndex && 
                                    mediaPlayer.currentIndex >= toIndex
                                ) {
                                    mediaPlayer.currentIndex++;
                                }
                                
                                mediaPlayer.savePlaylist();
                                mediaPlayer.renderPlaylist();
                                showToast('Playlist order updated');
                            }
                            
                            touchDraggedItem.style.opacity = '1';
                            touchDraggedItem = null;
                            dragOverItem = null;
                        }, { passive: true });
                        
                        // Cancel drag on touch cancel
                        item.addEventListener('touchcancel', function(e) {
                            if (touchDraggedItem) {
                                touchDraggedItem.style.opacity = '1';
                                touchDraggedItem = null;
                            }
                            
                            if (dragOverItem) {
                                dragOverItem.style.backgroundColor = '';
                                dragOverItem = null;
                            }
                        }, { passive: true });
                    });
                    
                    // Touch drag and drop for mobile
                },
                
                getTypeLabel: function(type) {
                    switch(type) {
                        case 'youtube': return 'YouTube';
                        case 'youtube-playlist': return 'YT Playlist';
                        case 'mp3': return 'MP3';
                        case 'wav': return 'WAV';
                        case 'flac': return 'FLAC';
                        case 'mp4': return 'MP4';
                        case 'gif': return 'GIF';
                        default: return type.toUpperCase();
                    }
                },
                
                getFilenameFromUrl: function(url) {
                    try {
                        const pathname = new URL(url).pathname;
                        const filename = pathname.split('/').pop();
                        return filename || url;
                    } catch (e) {
                        return url;
                    }
                },
                
                addMedia: function(media) {
                    this.playlist.push(media);
                    this.savePlaylist();
                    this.renderPlaylist();
                    
                    // If this is the first item, load it
                    if (this.playlist.length === 1) {
                        this.loadMedia();
                    }
                },
                
                removeMedia: function(index) {
                    this.playlist.splice(index, 1);
                    
                    // Update current index if needed
                    if (this.currentIndex === index) {
                        if (this.playlist.length > 0) {
                            this.currentIndex = 0;
                            this.loadMedia();
                        } else {
                            this.clearMedia();
                        }
                    } else if (this.currentIndex > index) {
                        this.currentIndex--;
                    }
                    
                    this.savePlaylist();
                    this.renderPlaylist();
                    showToast('Media removed from playlist');
                },
                
                loadMedia: function() {
                    // Stop current media
                    this.stopMedia();
                    
                    if (this.playlist.length === 0 || this.currentIndex >= this.playlist.length) {
                        return;
                    }
                    
                    const media = this.playlist[this.currentIndex];
                    this.videoScreen.innerHTML = '';
                    
                    // Create audioInfoOverlay
                    const audioInfoOverlay = document.createElement('div');
                    audioInfoOverlay.classList.add('audio-info-overlay');
                    if (!this.showAudioInfo) {
                        audioInfoOverlay.classList.add('hidden');
                    }
                    audioInfoOverlay.innerHTML = `
                        <h3 class="audio-title">${media.title || this.getFilenameFromUrl(media.url)}</h3>
                        <p class="audio-url">${media.url}</p>
                    `;
                    this.audioInfoOverlay = audioInfoOverlay;
                    this.videoScreen.appendChild(audioInfoOverlay);
                    
                    // Create visualizer container
                    const visualizerContainer = document.createElement('div');
                    visualizerContainer.classList.add('visualizer-container');
                    visualizerContainer.innerHTML = `<canvas class="visualizer-canvas"></canvas>`;
                    this.visualizerCanvas = visualizerContainer.querySelector('.visualizer-canvas');
                    this.videoScreen.appendChild(visualizerContainer);
                    
                    // Setup visualizer again
                    this.setupVisualizer();
                    
                    if (media.type === 'youtube' || media.type === 'youtube-playlist') {
                        this.loadYouTubeVideo(media.url);
                    } else if (media.type === 'mp3' || media.type === 'wav' || media.type === 'flac') {
                        this.loadAudio(media.url, media.title);
                    } else if (media.type === 'mp4') {
                        this.loadVideo(media.url);
                    } else if (media.type === 'gif') {
                        this.loadImage(media.url);
                    }
                    
                    // Update playlist
                    this.renderPlaylist();
                },
                
                stopMedia: function() {
                    // Cancel any animation frame
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    
                    // Stop any YouTube progress timer
                    this.stopYouTubeProgressTimer();
                    
                    // Stop YouTube player if exists
                    if (this.ytPlayer && typeof this.ytPlayer.stopVideo === 'function') {
                        try {
                            this.ytPlayer.stopVideo();
                        } catch (e) {
                            console.error('Error stopping YouTube video:', e);
                        }
                    }
                    
                    // Stop any playing media
                    if (this.mediaElement) {
                        if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                            this.mediaElement.pause();
                            this.mediaElement.src = '';
                            this.mediaElement.load();
                        }
                        this.mediaElement = null;
                    }
                    
                    this.ytPlayer = null;
                    this.isPlaying = false;
                    this.updatePlayPauseButton(false);
                },
                
                loadYouTubeVideo: function(url) {
                    const videoId = this.getYouTubeVideoId(url);
                    if (!videoId) {
                        showToast('Invalid YouTube URL');
                        return;
                    }
                    
                    // Create iframe for YouTube with API enabled
                    const iframe = document.createElement('iframe');
                    iframe.classList.add('video-element');
                    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1&origin=${window.location.origin}&controls=0`;
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                    iframe.allowFullscreen = true;
                    iframe.id = 'youtube-player';
                    
                    // Hide audio info for YouTube videos
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for YouTube videos
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add iframe to video screen
                    this.videoScreen.appendChild(iframe);
                    
                    // Add loading indicator
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.style.position = 'absolute';
                    loadingIndicator.style.top = '50%';
                    loadingIndicator.style.left = '50%';
                    loadingIndicator.style.transform = 'translate(-50%, -50%)';
                    loadingIndicator.style.zIndex = '98';
                    loadingIndicator.innerHTML = '<div class="spinner"></div><div style="margin-top:10px;color:white;">Loading YouTube video...</div>';
                    this.videoScreen.appendChild(loadingIndicator);
                    
                    // Set as current media element
                    this.mediaElement = iframe;
                    this.isPlaying = true;
                    this.updatePlayPauseButton(true);
                    
                    // Initialize YouTube API for controls
                    if (window.YT && YT.Player) {
                        this.initYouTubePlayer(iframe);
                        // Remove loading indicator after a short delay
                        setTimeout(() => loadingIndicator.remove(), 2000);
                    } else {
                        // Load YouTube API if not already loaded
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        const firstScriptTag = document.getElementsByTagName('script')[0];
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                        
                        // Setup callback when API is ready
                        window.onYouTubeIframeAPIReady = () => {
                            this.initYouTubePlayer(iframe);
                            // Remove loading indicator
                            loadingIndicator.remove();
                        };
                    }
                },
                
                initYouTubePlayer: function(iframe) {
                    this.ytPlayer = new YT.Player(iframe.id, {
                        events: {
                            'onReady': (event) => {
                                // Update timeline when loaded
                                this.updateYouTubeProgress();
                                // Store player reference
                                this.ytPlayer = event.target;
                                // Explicitly play video when player is ready
                                this.ytPlayer.playVideo();
                                
                                // Unmute the video after a short delay to ensure it starts playing
                                setTimeout(() => {
                                    if (this.ytPlayer && typeof this.ytPlayer.unMute === 'function') {
                                        this.ytPlayer.unMute();
                                        this.updateYouTubeVolumeUI();
                                        showToast('YouTube video unmuted');
                                    }
                                }, 1500);
                                
                                // More robust autoplay approach with multiple attempts
                                const attemptAutoplay = () => {
                                    this.ytPlayer.playVideo();
                                    
                                    // Create iframe overlay for better click interaction
                                    const overlay = document.createElement('div');
                                    overlay.style.position = 'absolute';
                                    overlay.style.top = '0';
                                    overlay.style.left = '0';
                                    overlay.style.width = '100%';
                                    overlay.style.height = '100%';
                                    overlay.style.zIndex = '99';
                                    overlay.style.cursor = 'pointer';
                                    
                                    // Add overlay to video screen
                                    this.videoScreen.appendChild(overlay);
                                    
                                    // Simulate multiple interaction methods
                                    const clickEvent = new MouseEvent('click', {
                                        bubbles: true,
                                        cancelable: true,
                                        view: window
                                    });
                                    iframe.dispatchEvent(clickEvent);
                                    overlay.dispatchEvent(clickEvent);
                                    
                                    // Also try touching/pressing
                                    const touchEvent = new TouchEvent('touchstart', {
                                        bubbles: true,
                                        cancelable: true,
                                        view: window
                                    });
                                    iframe.dispatchEvent(touchEvent);
                                    overlay.dispatchEvent(touchEvent);
                                    
                                    // Create and show click animation
                                    const clickAnimation = document.createElement('div');
                                    clickAnimation.style.position = 'absolute';
                                    clickAnimation.style.top = '50%';
                                    clickAnimation.style.left = '50%';
                                    clickAnimation.style.width = '60px';
                                    clickAnimation.style.height = '60px';
                                    clickAnimation.style.marginLeft = '-30px';
                                    clickAnimation.style.marginTop = '-30px';
                                    clickAnimation.style.borderRadius = '50%';
                                    clickAnimation.style.border = '3px solid #fff';
                                    clickAnimation.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                                    clickAnimation.style.zIndex = '100';
                                    clickAnimation.style.animation = 'pulse 0.5s ease-out';
                                    
                                    // Add keyframes for the pulse animation if they don't exist
                                    if (!document.querySelector('#pulse-animation')) {
                                        const style = document.createElement('style');
                                        style.id = 'pulse-animation';
                                        style.textContent = `
                                            @keyframes pulse {
                                                0% { transform: scale(0.5); opacity: 1; }
                                                100% { transform: scale(1.5); opacity: 0; }
                                            }
                                        `;
                                        document.head.appendChild(style);
                                    }
                                    
                                    this.videoScreen.appendChild(clickAnimation);
                                    
                                    // Remove animation after it completes
                                    setTimeout(() => {
                                        clickAnimation.remove();
                                    }, 500);
                                    
                                    // Create a direct play button overlay for user to click if autoplay fails
                                    const playButton = document.createElement('button');
                                    playButton.style.position = 'absolute';
                                    playButton.style.top = '50%';
                                    playButton.style.left = '50%';
                                    playButton.style.transform = 'translate(-50%, -50%)';
                                    playButton.style.zIndex = '101';
                                    playButton.style.padding = '15px 30px';
                                    playButton.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                                    playButton.style.color = 'white';
                                    playButton.style.border = '2px solid white';
                                    playButton.style.borderRadius = '5px';
                                    playButton.style.fontSize = '16px';
                                    playButton.style.cursor = 'pointer';
                                    playButton.style.opacity = '0';
                                    playButton.style.transition = 'opacity 0.5s ease-in';
                                    playButton.textContent = 'Click to Play';
                                    
                                    playButton.addEventListener('click', () => {
                                        this.ytPlayer.playVideo();
                                        playButton.remove();
                                        showToast('Starting YouTube video');
                                    });
                                    
                                    this.videoScreen.appendChild(playButton);
                                    
                    // Remove overlay after a short delay
                    setTimeout(() => {
                        overlay.remove();
                    }, 1000);
                    
                    // Check if video is playing after a few seconds, and try to play it again if needed
                    setTimeout(() => {
                        try {
                            const state = this.ytPlayer.getPlayerState();
                            if (state !== YT.PlayerState.PLAYING) {
                                this.ytPlayer.playVideo();
                                showToast('Starting YouTube video');
                            }
                        } catch (e) {
                            console.error('Error checking YouTube player state:', e);
                        }
                    }, 3000);
                            };
                            
                            // Try immediately
                            attemptAutoplay();
                            
                            // Try again after a short delay
                            setTimeout(attemptAutoplay, 2000);
                            
                            showToast('YouTube video loaded');
                        },
                        'onStateChange': (event) => {
                            // Update play/pause button based on state
                            if (event.data === YT.PlayerState.PLAYING) {
                                this.isPlaying = true;
                                this.updatePlayPauseButton(true);
                                this.startYouTubeProgressTimer();
                                showToast('YouTube video playing');
                            } else if (event.data === YT.PlayerState.PAUSED) {
                                this.isPlaying = false;
                                this.updatePlayPauseButton(false);
                                this.stopYouTubeProgressTimer();
                            } else if (event.data === YT.PlayerState.ENDED) {
                                this.playNext();
                            }
                        },
                        'onError': (event) => {
                            console.error('YouTube error:', event.data);
                            showToast('Error loading YouTube video. Try clicking play.');
                        }
                    }
                });
                },
                
                updateYouTubeProgress: function() {
                    if (!this.ytPlayer || typeof this.ytPlayer.getCurrentTime !== 'function') return;
                    
                    try {
                        const currentTime = this.ytPlayer.getCurrentTime() || 0;
                        const duration = this.ytPlayer.getDuration() || 0;
                        
                        if (duration > 0) {
                            const progress = (currentTime / duration) * 100;
                            this.timelineProgress.style.width = `${progress}%`;
                            
                            // Update time display
                            const currentTimeFormatted = this.formatTime(currentTime);
                            const durationFormatted = this.formatTime(duration);
                            this.timeDisplay.textContent = `${currentTimeFormatted} / ${durationFormatted}`;
                        }
                    } catch (e) {
                        console.error('Error updating YouTube progress:', e);
                    }
                },
                
                startYouTubeProgressTimer: function() {
                    this.stopYouTubeProgressTimer();
                    this.youtubeProgressTimer = setInterval(() => {
                        this.updateYouTubeProgress();
                    }, 500);
                },
                
                stopYouTubeProgressTimer: function() {
                    if (this.youtubeProgressTimer) {
                        clearInterval(this.youtubeProgressTimer);
                        this.youtubeProgressTimer = null;
                    }
                },
                
                togglePlay: function() {
                    if (!this.mediaElement) {
                        if (this.playlist.length > 0) {
                            this.loadMedia();
                        }
                        return;
                    }
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        if (this.isPlaying) {
                            this.mediaElement.pause();
                            this.isPlaying = false;
                            showToast('Paused');
                        } else {
                            this.mediaElement.play()
                                .then(() => {
                                    this.isPlaying = true;
                                    showToast('Playing');
                                })
                                .catch((error) => {
                                    console.error('Error playing media:', error);
                                    this.isPlaying = false;
                                    showToast('Error playing media. Try again.');
                                });
                        }
                        this.updatePlayPauseButton(this.isPlaying);
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // Control YouTube player
                        try {
                            const state = this.ytPlayer.getPlayerState();
                            if (state === YT.PlayerState.PLAYING) {
                                this.ytPlayer.pauseVideo();
                                this.isPlaying = false;
                                showToast('Paused');
                            } else {
                                this.ytPlayer.playVideo();
                                this.isPlaying = true;
                                showToast('Playing');
                            }
                            this.updatePlayPauseButton(this.isPlaying);
                        } catch (e) {
                            console.error('Error controlling YouTube:', e);
                            showToast('Error controlling YouTube player');
                        }
                    }
                },
                
                playPrevious: function() {
                    if (this.currentIndex <= 0) return;
                    
                    this.currentIndex--;
                    this.loadMedia();
                },
                
                playNext: function() {
                    if (this.repeatOne) {
                        // Just reload the current media
                        this.loadMedia();
                        return;
                    }
                    
                    if (this.shuffle) {
                        // Pick a random index that's not the current one
                        if (this.playlist.length > 1) {
                            let newIndex = this.currentIndex;
                            while (newIndex === this.currentIndex) {
                                newIndex = Math.floor(Math.random() * this.playlist.length);
                            }
                            this.currentIndex = newIndex;
                        }
                    } else {
                        // Normal sequential playback
                        if (this.currentIndex >= this.playlist.length - 1) {
                            if (this.repeatPlaylist) {
                                this.currentIndex = 0;
                            } else {
                                return; // End of playlist
                            }
                        } else {
                            this.currentIndex++;
                        }
                    }
                    
                    this.loadMedia();
                },
                
                updatePlayPauseButton: function(isPlaying) {
                    if (isPlaying) {
                        this.playIcon.style.display = 'none';
                        this.pauseIcon.style.display = 'block';
                    } else {
                        this.playIcon.style.display = 'block';
                        this.pauseIcon.style.display = 'none';
                    }
                },
                
                getYouTubeVideoId: function(url) {
                    try {
                        const urlObj = new URL(url);
                        if (url.includes('youtube.com')) {
                            return urlObj.searchParams.get('v') || '';
                        } else if (url.includes('youtu.be')) {
                            return urlObj.pathname.substring(1);
                        }
                    } catch (e) {
                        return '';
                    }
                    return '';
                },
                
                updateProgress: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    const progress = (this.mediaElement.currentTime / this.mediaElement.duration) * 100;
                    this.timelineProgress.style.width = `${progress}%`;
                },
                
                updateTimeDisplay: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    const currentTime = this.formatTime(this.mediaElement.currentTime);
                    const duration = this.formatTime(this.mediaElement.duration);
                    this.timeDisplay.textContent = `${currentTime} / ${duration}`;
                },
                
                updateBuffer: function() {
                    if (!this.mediaElement || (this.mediaElement.tagName !== 'AUDIO' && this.mediaElement.tagName !== 'VIDEO')) {
                        return;
                    }
                    
                    if (this.mediaElement.buffered.length > 0) {
                        const bufferedEnd = this.mediaElement.buffered.end(this.mediaElement.buffered.length - 1);
                        const duration = this.mediaElement.duration;
                        const bufferedPercent = (bufferedEnd / duration) * 100;
                        this.timelineBuffer.style.width = `${bufferedPercent}%`;
                    }
                },
                
                formatTime: function(seconds) {
                    if (isNaN(seconds)) return '0:00';
                    
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
                },
                
                loadAudio: function(url, title) {
                    // Create audio element
                    const audio = document.createElement('audio');
                    audio.classList.add('audio-element');
                    audio.crossOrigin = 'anonymous'; // For visualizer to work with remote audio
                    audio.src = url;
                    audio.controls = false;
                    
                    // Update audio info
                    this.audioInfoOverlay.querySelector('.audio-title').textContent = title || this.getFilenameFromUrl(url);
                    this.audioInfoOverlay.querySelector('.audio-url').textContent = url;
                    this.audioInfoOverlay.classList.remove('hidden');
                    
                    // Show visualizer
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'block';
                    }
                    
                    // Add audio to video screen
                    this.videoScreen.appendChild(audio);
                    
                    // Setup audio context for visualizer
                    if (this.audioContext && !this.audioContext.closed) {
                        this.audioContext.close();
                    }
                    
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 256;
                        
                        const source = this.audioContext.createMediaElementSource(audio);
                        source.connect(this.analyser);
                        this.analyser.connect(this.audioContext.destination);
                        
                        // Start visualizer
                        this.startVisualizer();
                    } catch (e) {
                        console.error('Error setting up audio visualizer:', e);
                    }
                    
                    // Set as current media element
                    this.mediaElement = audio;
                    
                    // Setup event listeners
                    audio.addEventListener('timeupdate', () => {
                        this.updateTimeDisplay();
                        this.updateProgress();
                    });
                    
                    audio.addEventListener('progress', () => {
                        this.updateBuffer();
                    });
                    
                    audio.addEventListener('ended', () => {
                        this.playNext();
                    });
                    
                    // Auto play
                    audio.play()
                        .then(() => {
                            this.isPlaying = true;
                            this.updatePlayPauseButton(true);
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            this.isPlaying = false;
                            this.updatePlayPauseButton(false);
                            showToast('Click play to start audio');
                        });
                },
                
                loadVideo: function(url) {
                    // Create video element
                    const video = document.createElement('video');
                    video.classList.add('video-element');
                    video.src = url;
                    video.controls = false;
                    video.playsInline = true;
                    
                    // Hide audio info for videos
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for videos
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add video to video screen
                    this.videoScreen.appendChild(video);
                    
                    // Set as current media element
                    this.mediaElement = video;
                    
                    // Setup event listeners
                    video.addEventListener('timeupdate', () => {
                        this.updateTimeDisplay();
                        this.updateProgress();
                    });
                    
                    video.addEventListener('progress', () => {
                        this.updateBuffer();
                    });
                    
                    video.addEventListener('ended', () => {
                        this.playNext();
                    });
                    
                    // Auto play
                    video.play()
                        .then(() => {
                            this.isPlaying = true;
                            this.updatePlayPauseButton(true);
                        })
                        .catch(error => {
                            console.error('Error playing video:', error);
                            this.isPlaying = false;
                            this.updatePlayPauseButton(false);
                            showToast('Click play to start video');
                        });
                },
                
                loadImage: function(url) {
                    // Create image element
                    const img = document.createElement('img');
                    img.classList.add('video-element');
                    img.src = url;
                    img.alt = this.getFilenameFromUrl(url);
                    
                    // Hide audio info for images
                    this.audioInfoOverlay.classList.add('hidden');
                    
                    // Hide visualizer for images
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        visualizerContainer.style.display = 'none';
                    }
                    
                    // Add image to video screen
                    this.videoScreen.appendChild(img);
                    
                    // Set as current media element but don't try to play it
                    this.mediaElement = img;
                    this.isPlaying = true;
                    this.updatePlayPauseButton(true);
                    
                    // Reset timeline
                    this.timeDisplay.textContent = '';
                    this.timelineProgress.style.width = '0%';
                },
                
                toggleMute: function() {
                    if (!this.mediaElement) return;
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        this.mediaElement.muted = !this.mediaElement.muted;
                        this.updateVolumeUI();
                        
                        showToast(this.mediaElement.muted ? 'Muted' : 'Unmuted');
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            const isMuted = this.ytPlayer.isMuted();
                            if (isMuted) {
                                this.ytPlayer.unMute();
                                showToast('Unmuted');
                            } else {
                                this.ytPlayer.mute();
                                showToast('Muted');
                            }
                            
                            // Update UI
                            setTimeout(() => this.updateYouTubeVolumeUI(), 100);
                        } catch (e) {
                            console.error('Error toggling YouTube mute:', e);
                        }
                    }
                },
                
                updateYouTubeVolumeUI: function() {
                    if (!this.ytPlayer) return;
                    
                    try {
                        const isMuted = this.ytPlayer.isMuted();
                        const volume = this.ytPlayer.getVolume() / 100;
                        
                        if (isMuted || volume === 0) {
                            this.volumeHighIcon.style.display = 'none';
                            this.volumeMuteIcon.style.display = 'block';
                        } else {
                            this.volumeHighIcon.style.display = 'block';
                            this.volumeMuteIcon.style.display = 'none';
                        }
                        
                        this.volumeSlider.value = isMuted ? 0 : volume * 100;
                    } catch (e) {
                        console.error('Error updating YouTube volume UI:', e);
                    }
                },
                
                setVolume: function(volume) {
                    if (!this.mediaElement) return;
                    
                    if (this.mediaElement.tagName === 'AUDIO' || this.mediaElement.tagName === 'VIDEO') {
                        this.mediaElement.volume = volume;
                        this.mediaElement.muted = volume === 0;
                        this.updateVolumeUI();
                    } else if (this.mediaElement.tagName === 'IFRAME' && this.ytPlayer) {
                        // For YouTube videos
                        try {
                            this.ytPlayer.setVolume(volume * 100);
                            
                            if (volume === 0) {
                                this.ytPlayer.mute();
                            } else if (this.ytPlayer.isMuted()) {
                                this.ytPlayer.unMute();
                            }
                            
                            this.updateYouTubeVolumeUI();
                        } catch (e) {
                            console.error('Error setting YouTube volume:', e);
                        }
                    }
                },
                
                startVisualizer: function() {
                    // Start animation loop
                    this.animationId = requestAnimationFrame(() => {
                        this.updateVisualizer();
                        this.startVisualizer();
                    });
                },
                
                updateVisualizer: function() {
                    // Clear canvas
                    const ctx = this.visualizerCanvas.getContext('2d');
                    ctx.clearRect(0, 0, this.visualizerCanvas.width, this.visualizerCanvas.height);
                    
                    // Draw based on visualizer type
                    if (this.visualizerType === 'bars') {
                        const frequencyData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(frequencyData);
                        
                        const barWidth = this.visualizerCanvas.width / frequencyData.length;
                        const barHeightScale = this.visualizerCanvas.height / 256;
                        
                        ctx.fillStyle = this.visualizerColor;
                        frequencyData.forEach((value, index) => {
                            ctx.fillRect(index * barWidth, this.visualizerCanvas.height - value * barHeightScale, barWidth, value * barHeightScale);
                        });
                    } else if (this.visualizerType === 'wave') {
                        const timeDomainData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteTimeDomainData(timeDomainData);
                        
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = this.visualizerColor;
                        ctx.moveTo(0, this.visualizerCanvas.height / 2);
                        timeDomainData.forEach((value, index) => {
                            const x = index * this.visualizerCanvas.width / timeDomainData.length;
                            const y = this.visualizerCanvas.height / 2 + value * (this.visualizerCanvas.height / 2) / 128;
                            ctx.lineTo(x, y);
                        });
                        ctx.stroke();
                    } else if (this.visualizerType === 'circle') {
                        const frequencyData = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(frequencyData);
                        
                        const radiusScale = this.visualizerCanvas.width / 2 / 256;
                        ctx.fillStyle = this.visualizerColor;
                        frequencyData.forEach((value, index) => {
                            const radius = value * radiusScale;
                            ctx.beginPath();
                            ctx.arc(this.visualizerCanvas.width / 2, this.visualizerCanvas.height / 2, radius, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                    } else if (this.visualizerType === 'particles') {
                        // Particles visualizer is not implemented yet
                    }
                },
                setupVisualizer: function() {
                    if (!this.visualizerCanvas) {
                        this.visualizerCanvas = $('.visualizer-canvas');
                        if (!this.visualizerCanvas) {
                            console.error('Could not find visualizer canvas');
                            return;
                        }
                    }
                    
                    // Set canvas dimensions to match container
                    const visualizerContainer = document.querySelector('.visualizer-container');
                    if (visualizerContainer) {
                        const rect = visualizerContainer.getBoundingClientRect();
                        this.visualizerCanvas.width = rect.width;
                        this.visualizerCanvas.height = rect.height;
                    }
                    
                    // Initialize particles if using particle visualizer
                    if (this.visualizerType === 'particles') {
                        this.initParticles();
                    }
                },
                
                initParticles: function() {
                    // Initialize particles for particle visualizer
                    this.particles = [];
                    const particleCount = 100;
                    
                    for (let i = 0; i < particleCount; i++) {
                        this.particles.push({
                            x: Math.random() * this.visualizerCanvas.width,
                            y: Math.random() * this.visualizerCanvas.height,
                            radius: Math.random() * 3 + 1,
                            color: this.visualizerColor,
                            velocity: {
                                x: Math.random() * 2 - 1,
                                y: Math.random() * 2 - 1
                            }
                        });
                    }
                },
                
                addSampleMedia: function() {
                    this.addMedia({
                        title: 'Sample Audio',
                        url: 'https://file-examples.com/storage/fe03757fe963b144a93c637/2017/11/file_example_MP3_700KB.mp3',
                        type: 'mp3'
                    });
                },
                
                savePlaybackSettings: function() {
                    try {
                        const settings = {
                            repeatPlaylist: this.repeatPlaylist,
                            repeatOne: this.repeatOne,
                            shuffle: this.shuffle
                        };
                        localStorage.setItem('mediaPlaybackSettings', JSON.stringify(settings));
                    } catch (e) {
                        console.error('Error saving playback settings:', e);
                    }
                },
                
                loadPlaybackSettings: function() {
                    try {
                        const savedSettings = localStorage.getItem('mediaPlaybackSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            this.repeatPlaylist = settings.repeatPlaylist || false;
                            this.repeatOne = settings.repeatOne || false;
                            this.shuffle = settings.shuffle || false;
                            
                            // Update UI to match
                            if (this.repeatPlaylist) {
                                this.repeatPlaylistBtn.classList.add('active');
                            }
                            if (this.repeatOne) {
                                this.repeatOneBtn.classList.add('active');
                            }
                            if (this.shuffle) {
                                this.shuffleBtn.classList.add('active');
                            }
                        }
                    } catch (e) {
                        console.error('Error loading playback settings:', e);
                    }
                }
            };
            
            window.mediaPlayer.init();
        }
        
        // Post Feed functionality
        function initPostFeed() {
            const postFeed = {
                container: $('#post-feed'),
                postGrid: $('.post-grid'),
                posts: [],
                tags: new Set(),
                currentSort: 'newest',
                currentFilters: {
                    types: [],
                    search: '',
                    tags: []
                },
                
                init: function() {
                    // Load posts from localStorage
                    this.loadPosts();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Render posts
                    this.renderPosts();
                    
                    // Add sample posts
                    if (this.posts.length === 0) {
                        this.addSamplePosts();
                    }
                    
                    // Populate tags dropdown
                    this.populateTagsDropdown();
                },
                
                loadPosts: function() {
                    const savedPosts = localStorage.getItem('postFeed');
                    if (savedPosts) {
                        try {
                            this.posts = JSON.parse(savedPosts);
                            
                            // Collect all tags
                            this.posts.forEach(post => {
                                post.tags.forEach(tag => this.tags.add(tag));
                            });
                        } catch (e) {
                            console.error('Error parsing posts:', e);
                            this.posts = [];
                        }
                    }
                },
                
                savePosts: function() {
                    try {
                        localStorage.setItem('postFeed', JSON.stringify(this.posts));
                    } catch (e) {
                        console.error('Error saving posts:', e);
                        showToast('Error saving posts');
                    }
                },
                
                setupEventListeners: function() {
                    // New post button
                    $('.new-post-btn').addEventListener('click', () => {
                        $('#new-post-modal').classList.add('open');
                    });
                    
                    // Create post button
                    $('#create-post').addEventListener('click', () => {
                        this.createPost();
                    });
                    
                    // Filter toggle
                    $('.filter-toggle').addEventListener('click', () => {
                        $('.filter-panel').classList.toggle('open');
                    });
                    
                    // Clear filters button
                    $('.clear-filters-btn').addEventListener('click', () => {
                        // Clear checkboxes
                        $$('.filter-checkbox').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        
                        // Clear search input
                        $('#search-input').value = '';
                        
                        // Reset tag dropdown
                        $('#tag-filter').value = '';
                        
                        // Reset to newest sort
                        $('#sort-newest').checked = true;
                        this.currentSort = 'newest';
                        
                        // Update filters and render posts
                        this.updateFilters();
                        
                        showToast('Filters cleared');
                    });
                    
                    // Filter and sort inputs
                    $$('.filter-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            this.updateFilters();
                        });
                    });
                    
                    $('#search-input').addEventListener('input', () => {
                        this.updateFilters();
                    });
                    
                    $('#tag-filter').addEventListener('change', () => {
                        this.updateFilters();
                    });
                    
                    $$('input[name="sort"]').forEach(radio => {
                        radio.addEventListener('change', () => {
                            this.currentSort = radio.value;
                            this.renderPosts();
                        });
                    });
                    
                    // Tag input
                    const tagInput = $('#tag-input');
                    tagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            const tagText = tagInput.value.trim();
                            if (tagText) {
                                this.addTag(tagText);
                                tagInput.value = '';
                            }
                        }
                    });
                    
                    // Edit tag input
                    const editTagInput = $('#edit-tag-input');
                    editTagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            const tagText = editTagInput.value.trim();
                            if (tagText) {
                                this.addEditTag(tagText);
                                editTagInput.value = '';
                            }
                        }
                    });
                    
                    // Update post button
                    $('#update-post').addEventListener('click', () => {
                        this.updatePost();
                    });
                    
                    // Tag filtering when clicking on tags
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('post-tag')) {
                            const tagText = e.target.textContent.trim();
                            this.filterByTag(tagText);
                        }
                    });
                },
                
                filterByTag: function(tag) {
                    // Show the filter panel
                    $('.filter-panel').classList.add('open');
                    
                    // Set the tag dropdown to the selected tag
                    const tagSelect = $('#tag-filter');
                    if (Array.from(tagSelect.options).some(opt => opt.value === tag)) {
                        tagSelect.value = tag;
                    }
                    
                    // Update filters
                    this.updateFilters();
                    
                    // Show notification
                    showToast(`Filtering by tag: ${tag}`);
                },
                
                createPost: function() {
                    const title = $('#post-title').value.trim();
                    const embed = $('#post-embed').value.trim();
                    const tagElements = $$('.tag-item');
                    const tags = Array.from(tagElements).map(el => el.textContent.replace('×', '').trim());
                    
                    if (!title || !embed) {
                        showToast('Please enter a title and embed code/URL');
                        return;
                    }
                    
                    // Determine post type
                    let type = 'other';
                    if (embed.includes('youtube.com') || embed.includes('youtu.be')) {
                        type = 'video';
                    } else if (embed.includes('mp3') || embed.includes('wav') || embed.includes('flac')) {
                        type = 'audio';
                    } else if (embed.includes('mp4') || embed.includes('webm') || embed.includes('ogg')) {
                        type = 'video';
                    } else if (embed.includes('jpg') || embed.includes('jpeg') || embed.includes('png') || embed.includes('gif')) {
                        type = 'image';
                    }
                    
                    const post = {
                        id: Date.now().toString(),
                        title: title,
                        embed: embed,
                        type: type,
                        tags: tags,
                        date: new Date().toISOString()
                    };
                    
                    this.posts.unshift(post);
                    this.savePosts();
                    
                    // Add new tags to the set
                    tags.forEach(tag => this.tags.add(tag));
                    
                    // Clear form
                    $('#post-title').value = '';
                    $('#post-embed').value = '';
                    $('.tags-input').innerHTML = '<input type="text" id="tag-input" placeholder="Add tags...">';
                    
                    // Close modal
                    $('#new-post-modal').classList.remove('open');
                    
                    // Render posts
                    this.renderPosts();
                    
                    // Setup event listener for tag input again (since we replaced it)
                    const tagInput = $('#tag-input');
                    tagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            const tagText = tagInput.value.trim();
                            if (tagText) {
                                this.addTag(tagText);
                                tagInput.value = '';
                            }
                        }
                    });
                    
                    // Update tags dropdown
                    this.populateTagsDropdown();
                    
                    // Show notification
                    showToast('Post created successfully');
                },
                
                editPost: function(postId) {
                    const post = this.posts.find(p => p.id === postId);
                    if (!post) return;
                    
                    $('#edit-post-id').value = post.id;
                    $('#edit-post-title').value = post.title;
                    $('#edit-post-embed').value = post.embed;
                    
                    // Clear and add tags
                    const tagContainer = $('#edit-tags-container');
                    tagContainer.innerHTML = '<input type="text" id="edit-tag-input" placeholder="Add tags...">';
                    
                    post.tags.forEach(tag => {
                        this.addEditTag(tag);
                    });
                    
                    // Setup event listener for edit tag input
                    const editTagInput = $('#edit-tag-input');
                    editTagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            const tagText = editTagInput.value.trim();
                            if (tagText) {
                                this.addEditTag(tagText);
                                editTagInput.value = '';
                            }
                        }
                    });
                    
                    // Open modal
                    $('#edit-post-modal').classList.add('open');
                },
                
                updatePost: function() {
                    const postId = $('#edit-post-id').value;
                    const title = $('#edit-post-title').value.trim();
                    const embed = $('#edit-post-embed').value.trim();
                    const tagElements = $$('#edit-tags-container .tag-item');
                    const tags = Array.from(tagElements).map(el => el.textContent.replace('×', '').trim());
                    
                    if (!title || !embed) {
                        showToast('Please enter a title and embed code/URL');
                        return;
                    }
                    
                    // Find post index
                    const postIndex = this.posts.findIndex(p => p.id === postId);
                    if (postIndex === -1) return;
                    
                    // Determine post type
                    let type = 'other';
                    if (embed.includes('youtube.com') || embed.includes('youtu.be')) {
                        type = 'video';
                    } else if (embed.includes('mp3') || embed.includes('wav') || embed.includes('flac')) {
                        type = 'audio';
                    } else if (embed.includes('mp4') || embed.includes('webm') || embed.includes('ogg')) {
                        type = 'video';
                    } else if (embed.includes('jpg') || embed.includes('jpeg') || embed.includes('png') || embed.includes('gif')) {
                        type = 'image';
                    }
                    
                    // Update post
                    this.posts[postIndex] = {
                        ...this.posts[postIndex],
                        title: title,
                        embed: embed,
                        type: type,
                        tags: tags
                    };
                    
                    this.savePosts();
                    
                    // Recollect all tags
                    this.tags = new Set();
                    this.posts.forEach(post => {
                        post.tags.forEach(tag => this.tags.add(tag));
                    });
                    
                    // Close modal
                    $('#edit-post-modal').classList.remove('open');
                    
                    // Render posts
                    this.renderPosts();
                    
                    // Update tags dropdown
                    this.populateTagsDropdown();
                    
                    // Show notification
                    showToast('Post updated successfully');
                },
                
                deletePost: function(postId) {
                    if (!confirm('Are you sure you want to delete this post?')) return;
                    
                    const postIndex = this.posts.findIndex(p => p.id === postId);
                    if (postIndex === -1) return;
                    
                    this.posts.splice(postIndex, 1);
                    this.savePosts();
                    
                    // Recollect all tags
                    this.tags = new Set();
                    this.posts.forEach(post => {
                        post.tags.forEach(tag => this.tags.add(tag));
                    });
                    
                    // Render posts
                    this.renderPosts();
                    
                    // Update tags dropdown
                    this.populateTagsDropdown();
                    
                    // Show notification
                    showToast('Post deleted successfully');
                },
                
                addTag: function(tagText) {
                    if (!tagText) return;
                    
                    // Check if tag already exists
                    const existingTags = $$('.tag-item');
                    for (let i = 0; i < existingTags.length; i++) {
                        if (existingTags[i].textContent.replace('×', '').trim() === tagText) {
                            return;
                        }
                    }
                    
                    const tagItem = document.createElement('div');
                    tagItem.classList.add('tag-item');
                    tagItem.innerHTML = `
                        ${tagText}
                        <span class="tag-remove">&times;</span>
                    `;
                    
                    // Add event listener to remove tag
                    tagItem.querySelector('.tag-remove').addEventListener('click', () => {
                        tagItem.remove();
                    });
                    
                    $('.tags-input').insertBefore(tagItem, $('#tag-input'));
                },
                
                addEditTag: function(tagText) {
                    if (!tagText) return;
                    
                    // Check if tag already exists
                    const existingTags = $$('#edit-tags-container .tag-item');
                    for (let i = 0; i < existingTags.length; i++) {
                        if (existingTags[i].textContent.replace('×', '').trim() === tagText) {
                            return;
                        }
                    }
                    
                    const tagItem = document.createElement('div');
                    tagItem.classList.add('tag-item');
                    tagItem.innerHTML = `
                        ${tagText}
                        <span class="tag-remove">&times;</span>
                    `;
                    
                    // Add event listener to remove tag
                    tagItem.querySelector('.tag-remove').addEventListener('click', () => {
                        tagItem.remove();
                    });
                    
                    $('#edit-tags-container').insertBefore(tagItem, $('#edit-tag-input'));
                },
                
                updateFilters: function() {
                    // Get type filters
                    const typeFilters = [];
                    $$('.filter-checkbox:checked').forEach(checkbox => {
                        typeFilters.push(checkbox.getAttribute('data-type'));
                    });
                    
                    // Get search filter
                    const searchFilter = $('#search-input').value.trim().toLowerCase();
                    
                    // Get tag filter
                    const tagFilter = $('#tag-filter').value;
                    
                    this.currentFilters = {
                        types: typeFilters,
                        search: searchFilter,
                        tags: tagFilter ? [tagFilter] : []
                    };
                    
                    this.renderPosts();
                },
                
                filterPosts: function(posts) {
                    return posts.filter(post => {
                        // Filter by type
                        if (this.currentFilters.types.length > 0 && !this.currentFilters.types.includes(post.type)) {
                            return false;
                        }
                        
                        // Filter by search
                        if (this.currentFilters.search && 
                            !post.title.toLowerCase().includes(this.currentFilters.search) &&
                            !post.tags.some(tag => tag.toLowerCase().includes(this.currentFilters.search))) {
                            return false;
                        }
                        
                        // Filter by tag
                        if (this.currentFilters.tags.length > 0 && 
                            !this.currentFilters.tags.some(tag => post.tags.includes(tag))) {
                            return false;
                        }
                        
                        return true;
                    });
                },
                
                sortPosts: function(posts) {
                    switch (this.currentSort) {
                        case 'newest':
                            return posts.sort((a, b) => new Date(b.date) - new Date(a.date));
                        case 'oldest':
                            return posts.sort((a, b) => new Date(a.date) - new Date(b.date));
                        case 'a-z':
                            return posts.sort((a, b) => a.title.localeCompare(b.title));
                        case 'z-a':
                            return posts.sort((a, b) => b.title.localeCompare(a.title));
                        default:
                            return posts;
                    }
                },
                
                renderPosts: function() {
                    // Filter and sort posts
                    let filteredPosts = this.filterPosts(this.posts);
                    filteredPosts = this.sortPosts(filteredPosts);
                    
                    // Clear post grid
                    this.postGrid.innerHTML = '';
                    
                    if (filteredPosts.length === 0) {
                        this.postGrid.innerHTML = '<div class="comic-panel" style="padding: 20px; text-align: center;">No posts found</div>';
                        return;
                    }
                    
                    // Render posts
                    filteredPosts.forEach(post => {
                        const postEl = document.createElement('div');
                        postEl.classList.add('comic-panel', 'post');
                        postEl.setAttribute('data-id', post.id);
                        
                        // Generate embed HTML
                        let embedHtml = '';
                        let isVideoContent = false;
                        let embedClass = 'post-embed';
                        
                        if (this.isUrl(post.embed)) {
                            if (this.isYouTubeUrl(post.embed)) {
                                // YouTube embed
                                const videoId = this.getYouTubeVideoId(post.embed);
                                embedHtml = `<iframe class="post-embed video-embed" data-src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen loading="lazy"></iframe>`;
                                isVideoContent = true;
                            } else if (this.isImageUrl(post.embed)) {
                                // Image embed
                                embedHtml = `<img class="post-embed" data-src="${post.embed}" alt="${post.title}" loading="lazy">`;
                            } else if (this.isAudioUrl(post.embed)) {
                                // Audio embed
                                embedHtml = `<audio class="post-embed" data-src="${post.embed}" controls preload="none"></audio>`;
                            } else if (this.isVideoUrl(post.embed)) {
                                // Video embed
                                embedHtml = `<video class="post-embed video-embed" data-src="${post.embed}" controls preload="none" playsinline></video>`;
                                isVideoContent = true;
                            } else {
                                // Generic iframe
                                embedHtml = `<iframe class="post-embed" data-src="${post.embed}" frameborder="0" loading="lazy"></iframe>`;
                            }
                        } else {
                            // Assume it's an embed code - check if it looks like it contains video content
                            if (post.embed.includes('<iframe') && (
                                post.embed.includes('youtube.com') || 
                                post.embed.includes('vimeo.com') ||
                                post.type === 'video')) {
                                isVideoContent = true;
                                // Add the video-embed class to iframes in the HTML string
                                embedHtml = post.embed.replace('<iframe', '<iframe class="video-embed"');
                            } else {
                                embedHtml = post.embed;
                            }
                        }
                        
                        // Format date
                        const date = new Date(post.date);
                        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        
                        const contentClass = isVideoContent ? 'post-content video-content' : 'post-content';
                        
                        postEl.innerHTML = `
                            <div class="post-header">
                                <div class="post-actions">
                                    <button class="post-action edit-post" data-id="${post.id}">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM16 6h-3v5.5c0 1.38-1.12 2.5-2.5 2.5S10 13.88 10 12.5s1.12-2.5 2.5-2.5c.57 0 1.08.19 1.5.51V5h4v2zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
                                        </svg>
                                    </button>
                                    <button class="post-action delete-post" data-id="${post.id}">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v6h14V4z"/>
                                        </svg>
                                    </button>
                                </div>
                                <h3 class="post-title">${post.title}</h3>
                            </div>
                            <div class="${contentClass}">
                                ${embedHtml}
                            </div>
                            <div class="post-footer">
                                <div class="post-tags">
                                    ${post.tags.map(tag => `<div class="post-tag">${tag}</div>`).join('')}
                                </div>
                                <div class="post-date">${formattedDate}</div>
                            </div>
                        `;
                        
                        // Add event listeners
                        postEl.querySelector('.edit-post').addEventListener('click', () => {
                            this.editPost(post.id);
                        });
                        
                        postEl.querySelector('.delete-post').addEventListener('click', () => {
                            this.deletePost(post.id);
                        });
                        
                        this.postGrid.appendChild(postEl);
                    });
                },
                
                isUrl: function(str) {
                    try {
                        new URL(str);
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                
                isYouTubeUrl: function(url) {
                    return url.includes('youtube.com') || url.includes('youtu.be');
                },
                
                getYouTubeVideoId: function(url) {
                    try {
                        const urlObj = new URL(url);
                        if (url.includes('youtube.com')) {
                            return urlObj.searchParams.get('v') || '';
                        } else if (url.includes('youtu.be')) {
                            return urlObj.pathname.substring(1);
                        }
                    } catch (e) {
                        return '';
                    }
                    return '';
                },
                
                isImageUrl: function(url) {
                    const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                    return imageExtensions.some(ext => url.toLowerCase().endsWith(`.${ext}`));
                },
                
                isAudioUrl: function(url) {
                    const audioExtensions = ['mp3', 'wav', 'flac', 'ogg'];
                    return audioExtensions.some(ext => url.toLowerCase().endsWith(`.${ext}`));
                },
                
                isVideoUrl: function(url) {
                    const videoExtensions = ['mp4', 'webm', 'ogg', 'mov'];
                    return videoExtensions.some(ext => url.toLowerCase().endsWith(`.${ext}`));
                },
                
                addSamplePosts: function() {
                    // Add some sample posts for demonstration
                    this.posts = [
                        {
                            id: '1',
                            title: 'Rick Astley - Never Gonna Give You Up',
                            embed: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                            type: 'video',
                            tags: ['music', 'classic', 'meme'],
                            date: new Date(2023, 0, 1).toISOString()
                        },
                        {
                            id: '2',
                            title: 'Sample MP3 Audio',
                            embed: 'https://file-examples.com/storage/fe03757fe963b144a93c637/2017/11/file_example_MP3_700KB.mp3',
                            type: 'audio',
                            tags: ['audio', 'sample'],
                            date: new Date(2023, 0, 2).toISOString()
                        },
                        {
                            id: '3',
                            title: 'Sample MP4 Video',
                            embed: 'https://file-examples.com/storage/fe03757fe963b144a93c637/2017/04/file_example_MP4_480_1_5MG.mp4',
                            type: 'video',
                            tags: ['video', 'sample'],
                            date: new Date(2023, 0, 3).toISOString()
                        }
                    ];
                    
                    // Collect all tags
                    this.posts.forEach(post => {
                        post.tags.forEach(tag => this.tags.add(tag));
                    });
                    
                    this.savePosts();
                    this.renderPosts();
                },
                
                populateTagsDropdown: function() {
                    const tagSelect = $('#tag-filter');
                    const currentValue = tagSelect.value; // Store current selection
                    
                    // Clear existing options except the first one
                    while (tagSelect.options.length > 1) {
                        tagSelect.remove(1);
                    }
                    
                    // Add tags as options
                    const sortedTags = Array.from(this.tags).sort();
                    sortedTags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag;
                        option.textContent = tag;
                        tagSelect.appendChild(option);
                    });
                    
                    // Restore selection if possible
                    if (currentValue && sortedTags.includes(currentValue)) {
                        tagSelect.value = currentValue;
                    }
                },
                
                filterByTag: function(tag) {
                    // Show the filter panel
                    $('.filter-panel').classList.add('open');
                    
                    // Set the tag dropdown to the selected tag
                    const tagSelect = $('#tag-filter');
                    if (Array.from(tagSelect.options).some(opt => opt.value === tag)) {
                        tagSelect.value = tag;
                    }
                    
                    // Update filters
                    this.updateFilters();
                    
                    // Show notification
                    showToast(`Filtering by tag: ${tag}`);
                },
                
            };
            
            postFeed.init();
        }
        
        // Modal functionality
        function initModals() {
            // Close buttons
            $$('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('open');
                });
            });
            
            // Close when clicking outside the modal content
            $$('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('open');
                    }
                });
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    $$('.modal.open').forEach(modal => {
                        modal.classList.remove('open');
                    });
                }
            });
        }
        
        // Lazy loading for post embeds
        function setupLazyLoading() {
            // Initialize Intersection Observer
            const options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        const src = element.getAttribute('data-src');
                        
                        if (src) {
                            if (element.tagName === 'IFRAME' || element.tagName === 'IMG') {
                                element.src = src;
                            } else if (element.tagName === 'VIDEO' || element.tagName === 'AUDIO') {
                                element.src = src;
                                // Don't autoplay
                                element.addEventListener('loadedmetadata', () => {
                                    // Just ensure controls are visible
                                    element.controls = true;
                                });
                            }
                            
                            element.removeAttribute('data-src');
                            observer.unobserve(element);
                        }
                    }
                });
            }, options);
            
            // Helper function to observe elements with data-src
            function observeLazyElements() {
                $$('[data-src]').forEach(element => {
                    observer.observe(element);
                });
            }
            
            // Initial observation
            observeLazyElements();
            
            // Re-observe when post feed tab is activated
            $$('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.getAttribute('data-tab') === 'post-feed') {
                        setTimeout(observeLazyElements, 100);
                    }
                });
            });
        }
        
        // Corner fold functionality
        function setupCornerFolds() {
            // Add clickable corner areas to all panels
            document.querySelectorAll('.comic-panel:not(.filter-panel)').forEach(panel => {
                if (!panel.querySelector('.corner-fold-click-area')) {
                    const clickArea = document.createElement('div');
                    clickArea.classList.add('corner-fold-click-area');
                    
                    // Add event listener directly to this element
                    clickArea.addEventListener('click', function(e) {
                        // If it's a post, toggle collapsed state
                        if (panel.classList.contains('post')) {
                            panel.classList.toggle('collapsed');
                            
                            // Remember collapsed state
                            if (panel.hasAttribute('data-id')) {
                                const postId = panel.getAttribute('data-id');
                                const collapsedPosts = JSON.parse(localStorage.getItem('collapsedPosts') || '[]');
                                
                                if (panel.classList.contains('collapsed')) {
                                    if (!collapsedPosts.includes(postId)) {
                                        collapsedPosts.push(postId);
                                    }
                                } else {
                                    const index = collapsedPosts.indexOf(postId);
                                    if (index > -1) {
                                        collapsedPosts.splice(index, 1);
                                    }
                                }
                                
                                localStorage.setItem('collapsedPosts', JSON.stringify(collapsedPosts));
                            }
                            
                            showToast(panel.classList.contains('collapsed') ? 'Post collapsed' : 'Post expanded');
                            e.stopPropagation();
                        } else if (panel.classList.contains('media-player')) {
                            // Toggle fullscreen for media player
                            if (document.fullscreenElement) {
                                if (document.exitFullscreen) {
                                    document.exitFullscreen();
                                } else if (document.webkitExitFullscreen) {
                                    document.webkitExitFullscreen();
                                } else if (document.msExitFullscreen) {
                                    document.msExitFullscreen();
                                }
                                showToast('Exited fullscreen');
                            } else {
                                if (panel.requestFullscreen) {
                                    panel.requestFullscreen();
                                } else if (panel.webkitRequestFullscreen) {
                                    panel.webkitRequestFullscreen();
                                } else if (panel.msRequestFullscreen) {
                                    panel.msRequestFullscreen();
                                }
                                showToast('Entered fullscreen');
                            }
                            e.stopPropagation();
                        }
                    });
                    
                    panel.appendChild(clickArea);
                }
                
                // Add tooltip if not already present
                if (!panel.querySelector('.corner-fold-tooltip')) {
                    const tooltip = document.createElement('div');
                    tooltip.classList.add('corner-fold-tooltip');
                    
                    // Custom tooltip text based on panel type
                    if (panel.classList.contains('post')) {
                        tooltip.textContent = 'Click to collapse/expand';
                    } else if (panel.classList.contains('media-player')) {
                        tooltip.textContent = 'Click for fullscreen';
                    } else {
                        tooltip.textContent = 'Click corner';
                    }
                    
                    panel.appendChild(tooltip);
                }
            });
            
            // Initialize collapsed state from localStorage for posts
            const collapsedPosts = JSON.parse(localStorage.getItem('collapsedPosts') || '[]');
            collapsedPosts.forEach(postId => {
                const post = document.querySelector(`.post[data-id="${postId}"]`);
                if (post) {
                    post.classList.add('collapsed');
                }
            });
        }

        // Add animation to buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('pow-btn') || e.target.closest('.pow-btn')) {
                const button = e.target.classList.contains('pow-btn') ? e.target : e.target.closest('.pow-btn');
                button.classList.remove('pow-animation');
                
                // Trigger reflow
                void button.offsetWidth;
                
                button.classList.add('pow-animation');
            }
        });
    </script>
</body>
</html>